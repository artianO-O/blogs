import{_ as s,c as a,a as p,o as t}from"./app-BYt8acor.js";const e={};function o(c,n){return t(),a("div",null,n[0]||(n[0]=[p(`<h1 id="vue3ç¼–è¯‘å™¨ç³»ç»Ÿè¯¦è§£" tabindex="-1"><a class="header-anchor" href="#vue3ç¼–è¯‘å™¨ç³»ç»Ÿè¯¦è§£"><span>Vue3ç¼–è¯‘å™¨ç³»ç»Ÿè¯¦è§£</span></a></h1><h2 id="ğŸ¯-ç¼–è¯‘å™¨æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-ç¼–è¯‘å™¨æ¦‚è¿°"><span>ğŸ¯ ç¼–è¯‘å™¨æ¦‚è¿°</span></a></h2><p>Vue3çš„ç¼–è¯‘å™¨ç³»ç»Ÿæ˜¯æ¡†æ¶çš„æ ¸å¿ƒä¼˜åŒ–å¼•æ“ï¼Œå®ƒå°†æ¨¡æ¿ç¼–è¯‘æˆé«˜æ•ˆçš„æ¸²æŸ“å‡½æ•°ï¼Œå®ç°äº†ç¼–è¯‘æ—¶ä¼˜åŒ–å’Œè¿è¡Œæ—¶æ€§èƒ½æå‡ã€‚</p><h3 id="ç¼–è¯‘å™¨æ¶æ„å›¾" tabindex="-1"><a class="header-anchor" href="#ç¼–è¯‘å™¨æ¶æ„å›¾"><span>ç¼–è¯‘å™¨æ¶æ„å›¾</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚        æ¨¡æ¿å±‚ (Template Layer)      â”‚</span>
<span class="line">â”‚  &lt;template&gt; | å­—ç¬¦ä¸²æ¨¡æ¿ | JSX      â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚        è§£æå±‚ (Parse Layer)         â”‚</span>
<span class="line">â”‚  è¯æ³•åˆ†æ | è¯­æ³•åˆ†æ | ASTç”Ÿæˆ      â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚        è½¬æ¢å±‚ (Transform Layer)     â”‚</span>
<span class="line">â”‚  é™æ€æå‡ | è¡¥ä¸æ ‡å¿— | å—çº§ä¼˜åŒ–     â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚        ç”Ÿæˆå±‚ (Codegen Layer)       â”‚</span>
<span class="line">â”‚  æ¸²æŸ“å‡½æ•° | ä¼˜åŒ–ä»£ç  | æºç æ˜ å°„     â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”-è§£æé˜¶æ®µ-parse" tabindex="-1"><a class="header-anchor" href="#ğŸ”-è§£æé˜¶æ®µ-parse"><span>ğŸ” è§£æé˜¶æ®µ (Parse)</span></a></h2><h3 id="_1-è¯æ³•åˆ†æ-lexical-analysis" tabindex="-1"><a class="header-anchor" href="#_1-è¯æ³•åˆ†æ-lexical-analysis"><span>1. è¯æ³•åˆ†æ (Lexical Analysis)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// è¯æ³•åˆ†æå™¨çŠ¶æ€</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">enum</span> State <span class="token punctuation">{</span></span>
<span class="line">  Text <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// æ–‡æœ¬çŠ¶æ€</span></span>
<span class="line">  InterpolationOpen<span class="token punctuation">,</span> <span class="token comment">// æ’å€¼å¼€å§‹</span></span>
<span class="line">  Interpolation<span class="token punctuation">,</span> <span class="token comment">// æ’å€¼å†…å®¹</span></span>
<span class="line">  InterpolationClose<span class="token punctuation">,</span> <span class="token comment">// æ’å€¼ç»“æŸ</span></span>
<span class="line">  BeforeTagName<span class="token punctuation">,</span> <span class="token comment">// æ ‡ç­¾åå‰</span></span>
<span class="line">  InTagName<span class="token punctuation">,</span> <span class="token comment">// æ ‡ç­¾åä¸­</span></span>
<span class="line">  InSelfClosingTag<span class="token punctuation">,</span> <span class="token comment">// è‡ªé—­åˆæ ‡ç­¾</span></span>
<span class="line">  BeforeClosingTagName<span class="token punctuation">,</span> <span class="token comment">// ç»“æŸæ ‡ç­¾åå‰</span></span>
<span class="line">  InClosingTagName<span class="token punctuation">,</span> <span class="token comment">// ç»“æŸæ ‡ç­¾åä¸­</span></span>
<span class="line">  AfterClosingTagName<span class="token punctuation">,</span> <span class="token comment">// ç»“æŸæ ‡ç­¾åå</span></span>
<span class="line">  BeforeAttrName<span class="token punctuation">,</span> <span class="token comment">// å±æ€§åå‰</span></span>
<span class="line">  InAttrName<span class="token punctuation">,</span> <span class="token comment">// å±æ€§åä¸­</span></span>
<span class="line">  InDirName<span class="token punctuation">,</span> <span class="token comment">// æŒ‡ä»¤åä¸­</span></span>
<span class="line">  InDirArg<span class="token punctuation">,</span> <span class="token comment">// æŒ‡ä»¤å‚æ•°ä¸­</span></span>
<span class="line">  InDirDynamicArg<span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€æŒ‡ä»¤å‚æ•°ä¸­</span></span>
<span class="line">  InDirModifier<span class="token punctuation">,</span> <span class="token comment">// æŒ‡ä»¤ä¿®é¥°ç¬¦ä¸­</span></span>
<span class="line">  AfterAttrName<span class="token punctuation">,</span> <span class="token comment">// å±æ€§åå</span></span>
<span class="line">  BeforeAttrValue<span class="token punctuation">,</span> <span class="token comment">// å±æ€§å€¼å‰</span></span>
<span class="line">  InAttrValueDq<span class="token punctuation">,</span> <span class="token comment">// åŒå¼•å·å±æ€§å€¼</span></span>
<span class="line">  InAttrValueSq<span class="token punctuation">,</span> <span class="token comment">// å•å¼•å·å±æ€§å€¼</span></span>
<span class="line">  InAttrValueNq<span class="token punctuation">,</span> <span class="token comment">// æ— å¼•å·å±æ€§å€¼</span></span>
<span class="line">  BeforeDeclaration<span class="token punctuation">,</span> <span class="token comment">// å£°æ˜å‰</span></span>
<span class="line">  InDeclaration<span class="token punctuation">,</span> <span class="token comment">// å£°æ˜ä¸­</span></span>
<span class="line">  BeforeComment<span class="token punctuation">,</span> <span class="token comment">// æ³¨é‡Šå‰</span></span>
<span class="line">  InComment<span class="token punctuation">,</span> <span class="token comment">// æ³¨é‡Šä¸­</span></span>
<span class="line">  BeforeSpecialS<span class="token punctuation">,</span> <span class="token comment">// ç‰¹æ®Šæ ‡ç­¾å‰</span></span>
<span class="line">  BeforeSpecialT<span class="token punctuation">,</span> <span class="token comment">// ç‰¹æ®Šæ ‡ç­¾å‰</span></span>
<span class="line">  InRCDATA<span class="token punctuation">,</span> <span class="token comment">// RCDATAä¸­</span></span>
<span class="line">  InEntity<span class="token punctuation">,</span> <span class="token comment">// å®ä½“ä¸­</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¯æ³•åˆ†æå™¨</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">baseParse</span><span class="token punctuation">(</span></span>
<span class="line">  content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">  options<span class="token operator">:</span> ParserOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> RootNode <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createParserContext</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> options<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">getCursor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">createRoot</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">getSelection</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-è¯­æ³•åˆ†æ-syntax-analysis" tabindex="-1"><a class="header-anchor" href="#_2-è¯­æ³•åˆ†æ-syntax-analysis"><span>2. è¯­æ³•åˆ†æ (Syntax Analysis)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// è§£æå­èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span></span>
<span class="line">  context<span class="token operator">:</span> ParserContext<span class="token punctuation">,</span></span>
<span class="line">  mode<span class="token operator">:</span> TextModes<span class="token punctuation">,</span></span>
<span class="line">  ancestors<span class="token operator">:</span> ElementNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>ancestors<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">const</span> ns <span class="token operator">=</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span>ns <span class="token operator">:</span> Namespaces<span class="token punctuation">.</span><span class="token constant">HTML</span></span>
<span class="line">  <span class="token keyword">const</span> nodes<span class="token operator">:</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEnd</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> s <span class="token operator">=</span> context<span class="token punctuation">.</span>source</span>
<span class="line">    <span class="token keyword">let</span> node<span class="token operator">:</span> TemplateChildNode <span class="token operator">|</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token keyword">undefined</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">||</span> mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">RCDATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> context<span class="token punctuation">.</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// è§£ææ’å€¼</span></span>
<span class="line">        node <span class="token operator">=</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;&lt;&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// è§£ææ ‡ç­¾</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">EOF_IN_TAG</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;!&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token comment">// è§£ææ³¨é‡Šæˆ–DOCTYPE</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&#39;&lt;!--&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            node <span class="token operator">=</span> <span class="token function">parseComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&#39;&lt;!DOCTYPE&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">&#39;&lt;![CDATA[&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>ns <span class="token operator">!==</span> Namespaces<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              node <span class="token operator">=</span> <span class="token function">parseCDATA</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">CDATA_IN_HTML_CONTENT</span><span class="token punctuation">)</span></span>
<span class="line">              node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">INCORRECTLY_OPENED_COMMENT</span><span class="token punctuation">)</span></span>
<span class="line">            node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token comment">// è§£æç»“æŸæ ‡ç­¾</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[a-z]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> TagType<span class="token punctuation">.</span>End<span class="token punctuation">,</span> parent<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="token punctuation">)</span></span>
<span class="line">            node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[a-z]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token comment">// è§£æå¼€å§‹æ ‡ç­¾</span></span>
<span class="line">          node <span class="token operator">=</span> <span class="token function">parseElement</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;?&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function">emitError</span><span class="token punctuation">(</span></span>
<span class="line">            context<span class="token punctuation">,</span></span>
<span class="line">            ErrorCodes<span class="token punctuation">.</span><span class="token constant">UNEXPECTED_QUESTION_MARK_INSTEAD_OF_TAG_NAME</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">)</span></span>
<span class="line">          node <span class="token operator">=</span> <span class="token function">parseBogusComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function">emitError</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">INVALID_FIRST_CHARACTER_OF_TAG_NAME</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// è§£ææ–‡æœ¬</span></span>
<span class="line">      node <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mode<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> node<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">pushNode</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> node<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">pushNode</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> node<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> nodes</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-astèŠ‚ç‚¹ç±»å‹" tabindex="-1"><a class="header-anchor" href="#_3-astèŠ‚ç‚¹ç±»å‹"><span>3. ASTèŠ‚ç‚¹ç±»å‹</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">enum</span> NodeTypes <span class="token punctuation">{</span></span>
<span class="line">  <span class="token constant">ROOT</span><span class="token punctuation">,</span> <span class="token comment">// æ ¹èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token comment">// å…ƒç´ èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token comment">// æ–‡æœ¬èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">COMMENT</span><span class="token punctuation">,</span> <span class="token comment">// æ³¨é‡ŠèŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span> <span class="token comment">// ç®€å•è¡¨è¾¾å¼</span></span>
<span class="line">  <span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span> <span class="token comment">// æ’å€¼è¡¨è¾¾å¼</span></span>
<span class="line">  <span class="token constant">ATTRIBUTE</span><span class="token punctuation">,</span> <span class="token comment">// å±æ€§èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">DIRECTIVE</span><span class="token punctuation">,</span> <span class="token comment">// æŒ‡ä»¤èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">COMPOUND_EXPRESSION</span><span class="token punctuation">,</span> <span class="token comment">// å¤åˆè¡¨è¾¾å¼</span></span>
<span class="line">  <span class="token constant">IF</span><span class="token punctuation">,</span> <span class="token comment">// æ¡ä»¶èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">IF_BRANCH</span><span class="token punctuation">,</span> <span class="token comment">// æ¡ä»¶åˆ†æ”¯</span></span>
<span class="line">  <span class="token constant">FOR</span><span class="token punctuation">,</span> <span class="token comment">// å¾ªç¯èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">TEXT_CALL</span><span class="token punctuation">,</span> <span class="token comment">// æ–‡æœ¬è°ƒç”¨</span></span>
<span class="line">  <span class="token constant">VNODE_CALL</span><span class="token punctuation">,</span> <span class="token comment">// VNodeè°ƒç”¨</span></span>
<span class="line">  <span class="token constant">JS_CALL_EXPRESSION</span><span class="token punctuation">,</span> <span class="token comment">// JSè°ƒç”¨è¡¨è¾¾å¼</span></span>
<span class="line">  <span class="token constant">JS_OBJECT_EXPRESSION</span><span class="token punctuation">,</span> <span class="token comment">// JSå¯¹è±¡è¡¨è¾¾å¼</span></span>
<span class="line">  <span class="token constant">JS_PROPERTY</span><span class="token punctuation">,</span> <span class="token comment">// JSå±æ€§</span></span>
<span class="line">  <span class="token constant">JS_ARRAY_EXPRESSION</span><span class="token punctuation">,</span> <span class="token comment">// JSæ•°ç»„è¡¨è¾¾å¼</span></span>
<span class="line">  <span class="token constant">JS_FUNCTION_EXPRESSION</span><span class="token punctuation">,</span> <span class="token comment">// JSå‡½æ•°è¡¨è¾¾å¼</span></span>
<span class="line">  <span class="token constant">JS_CONDITIONAL_EXPRESSION</span><span class="token punctuation">,</span> <span class="token comment">// JSæ¡ä»¶è¡¨è¾¾å¼</span></span>
<span class="line">  <span class="token constant">JS_CACHE_EXPRESSION</span><span class="token punctuation">,</span> <span class="token comment">// JSç¼“å­˜è¡¨è¾¾å¼</span></span>
<span class="line">  <span class="token constant">JS_BLOCK_STATEMENT</span><span class="token punctuation">,</span> <span class="token comment">// JSå—è¯­å¥</span></span>
<span class="line">  <span class="token constant">JS_TEMPLATE_LITERAL</span><span class="token punctuation">,</span> <span class="token comment">// JSæ¨¡æ¿å­—é¢é‡</span></span>
<span class="line">  <span class="token constant">JS_IF_STATEMENT</span><span class="token punctuation">,</span> <span class="token comment">// JS ifè¯­å¥</span></span>
<span class="line">  <span class="token constant">JS_ASSIGNMENT_EXPRESSION</span><span class="token punctuation">,</span> <span class="token comment">// JSèµ‹å€¼è¡¨è¾¾å¼</span></span>
<span class="line">  <span class="token constant">JS_SEQUENCE_EXPRESSION</span><span class="token punctuation">,</span> <span class="token comment">// JSåºåˆ—è¡¨è¾¾å¼</span></span>
<span class="line">  <span class="token constant">JS_RETURN_STATEMENT</span><span class="token punctuation">,</span> <span class="token comment">// JSè¿”å›è¯­å¥</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ASTèŠ‚ç‚¹æ¥å£</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span></span>
<span class="line">  type<span class="token operator">:</span> NodeTypes</span>
<span class="line">  loc<span class="token operator">:</span> SourceLocation</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ElementNode</span> <span class="token keyword">extends</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span></span>
<span class="line">  type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span></span>
<span class="line">  ns<span class="token operator">:</span> Namespaces</span>
<span class="line">  tag<span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  tagType<span class="token operator">:</span> ElementTypes</span>
<span class="line">  isSelfClosing<span class="token operator">:</span> <span class="token builtin">boolean</span></span>
<span class="line">  props<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>AttributeNode <span class="token operator">|</span> DirectiveNode<span class="token operator">&gt;</span></span>
<span class="line">  children<span class="token operator">:</span> TemplateChildNode<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">InterpolationNode</span> <span class="token keyword">extends</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span></span>
<span class="line">  type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span></span>
<span class="line">  content<span class="token operator">:</span> ExpressionNode</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">SimpleExpressionNode</span> <span class="token keyword">extends</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span></span>
<span class="line">  type<span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span></span>
<span class="line">  content<span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  isStatic<span class="token operator">:</span> <span class="token builtin">boolean</span></span>
<span class="line">  constType<span class="token operator">:</span> ConstantTypes</span>
<span class="line">  hoisted<span class="token operator">?</span><span class="token operator">:</span> JSChildNode</span>
<span class="line">  isIdentifier<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”„-è½¬æ¢é˜¶æ®µ-transform" tabindex="-1"><a class="header-anchor" href="#ğŸ”„-è½¬æ¢é˜¶æ®µ-transform"><span>ğŸ”„ è½¬æ¢é˜¶æ®µ (Transform)</span></a></h2><h3 id="_1-è½¬æ¢å™¨æ¶æ„" tabindex="-1"><a class="header-anchor" href="#_1-è½¬æ¢å™¨æ¶æ„"><span>1. è½¬æ¢å™¨æ¶æ„</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// è½¬æ¢ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">TransformContext</span> <span class="token punctuation">{</span></span>
<span class="line">  root<span class="token operator">:</span> RootNode</span>
<span class="line">  helpers<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">symbol</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token generic-function"><span class="token function">helper</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token keyword">keyof</span> <span class="token keyword">typeof</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;./runtimeHelpers&#39;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  <span class="token function">helperString</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  <span class="token function">replaceNode</span><span class="token punctuation">(</span>node<span class="token operator">:</span> TemplateChildNode<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">removeNode</span><span class="token punctuation">(</span>node<span class="token operator">?</span><span class="token operator">:</span> TemplateChildNode<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">onNodeRemoved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">addIdentifiers</span><span class="token punctuation">(</span>exp<span class="token operator">:</span> ExpressionNode <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">removeIdentifiers</span><span class="token punctuation">(</span>exp<span class="token operator">:</span> ExpressionNode <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">hoist</span><span class="token punctuation">(</span>exp<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> JSChildNode <span class="token operator">|</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> JSChildNode<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  <span class="token generic-function"><span class="token function">cache</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> Node<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>exp<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> isVNode<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token constant">T</span></span>
<span class="line">  constantCache<span class="token operator">:</span> Map<span class="token operator">&lt;</span>TemplateChildNode<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">&gt;</span></span>
<span class="line">  filters<span class="token operator">?</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span>
<span class="line">  prefixIdentifiers<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span></span>
<span class="line">  <span class="token function">preTransformNode</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ElementNode<span class="token punctuation">)</span><span class="token operator">:</span> ElementNode <span class="token operator">|</span> <span class="token keyword">void</span></span>
<span class="line">  postTransformNode<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>node<span class="token operator">:</span> ElementNode<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> CompilerError<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// èŠ‚ç‚¹è½¬æ¢å™¨</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">NodeTransform</span> <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  node<span class="token operator">:</span> RootNode <span class="token operator">|</span> TemplateChildNode<span class="token punctuation">,</span></span>
<span class="line">  context<span class="token operator">:</span> TransformContext<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æŒ‡ä»¤è½¬æ¢å™¨</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">DirectiveTransform</span> <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  dir<span class="token operator">:</span> DirectiveNode<span class="token punctuation">,</span></span>
<span class="line">  node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span></span>
<span class="line">  context<span class="token operator">:</span> TransformContext<span class="token punctuation">,</span></span>
<span class="line">  augmentor<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>ret<span class="token operator">:</span> DirectiveTransformResult<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DirectiveTransformResult<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DirectiveTransformResult</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-é™æ€æå‡-static-hoisting" tabindex="-1"><a class="header-anchor" href="#_2-é™æ€æå‡-static-hoisting"><span>2. é™æ€æå‡ (Static Hoisting)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// é™æ€æå‡è½¬æ¢å™¨</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> transformHoist<span class="token operator">:</span> <span class="token function-variable function">NodeTransform</span> <span class="token operator">=</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span></span>
<span class="line">    node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">    node<span class="token punctuation">.</span>tagType <span class="token operator">===</span> ElementTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span></span>
<span class="line">  <span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> constantCache <span class="token punctuation">}</span> <span class="token operator">=</span> context</span>
<span class="line"></span>
<span class="line">    <span class="token comment">// æ£€æŸ¥æ˜¯å¦ä¸ºé™æ€èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token keyword">const</span> hoisted <span class="token operator">=</span> <span class="token function">getHoistedNode</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>hoisted<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// æå‡é™æ€èŠ‚ç‚¹</span></span>
<span class="line">      context<span class="token punctuation">.</span><span class="token function">hoist</span><span class="token punctuation">(</span>hoisted<span class="token punctuation">)</span></span>
<span class="line">      <span class="token comment">// æ›¿æ¢ä¸ºé™æ€å¼•ç”¨</span></span>
<span class="line">      context<span class="token punctuation">.</span><span class="token function">replaceNode</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token function">createSimpleExpression</span><span class="token punctuation">(</span></span>
<span class="line">          context<span class="token punctuation">.</span><span class="token function">helperString</span><span class="token punctuation">(</span>HoistType<span class="token punctuation">.</span><span class="token constant">HOISTED</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">          node<span class="token punctuation">.</span>loc<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è·å–å¯æå‡çš„èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getHoistedNode</span><span class="token punctuation">(</span></span>
<span class="line">  node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span></span>
<span class="line">  context<span class="token operator">:</span> TransformContext<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> constantCache <span class="token punctuation">}</span> <span class="token operator">=</span> context</span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ£€æŸ¥æ˜¯å¦å·²ç»ç¼“å­˜</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>constantCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> constantCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ£€æŸ¥æ˜¯å¦ä¸ºé™æ€èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStaticNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> hoisted <span class="token operator">=</span> <span class="token function">generateStaticNode</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">    constantCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> hoisted<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> hoisted</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">undefined</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ£€æŸ¥é™æ€èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">isStaticNode</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ElementNode<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// æ£€æŸ¥å±æ€§æ˜¯å¦é™æ€</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> prop <span class="token keyword">of</span> node<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isStaticExp</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ£€æŸ¥å­èŠ‚ç‚¹æ˜¯å¦é™æ€</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStaticChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-è¡¥ä¸æ ‡å¿—-patch-flags" tabindex="-1"><a class="header-anchor" href="#_3-è¡¥ä¸æ ‡å¿—-patch-flags"><span>3. è¡¥ä¸æ ‡å¿— (Patch Flags)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// è¡¥ä¸æ ‡å¿—è½¬æ¢å™¨</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> transformElement<span class="token operator">:</span> <span class="token function-variable function">NodeTransform</span> <span class="token operator">=</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">!==</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> tag<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> node</span>
<span class="line">  <span class="token keyword">const</span> isComponent <span class="token operator">=</span> <span class="token function">isComponentTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// å¤„ç†ç»„ä»¶</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">transformComponent</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// å¤„ç†å…ƒç´ </span></span>
<span class="line">  <span class="token keyword">const</span> vnodeTag <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">  <span class="token keyword">const</span> vnodeProps <span class="token operator">=</span> <span class="token function">buildProps</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">const</span> vnodeChildren <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length</span>
<span class="line">    <span class="token operator">?</span> <span class="token function">buildChildren</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">    <span class="token operator">:</span> <span class="token keyword">undefined</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// ç”Ÿæˆè¡¥ä¸æ ‡å¿—</span></span>
<span class="line">  <span class="token keyword">const</span> patchFlag <span class="token operator">=</span> <span class="token function">getPatchFlag</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// ç”ŸæˆåŠ¨æ€å±æ€§</span></span>
<span class="line">  <span class="token keyword">const</span> dynamicProps <span class="token operator">=</span> <span class="token function">getDynamicProps</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// åˆ›å»ºVNodeè°ƒç”¨</span></span>
<span class="line">  context<span class="token punctuation">.</span><span class="token function">replaceNode</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token function">createVNodeCall</span><span class="token punctuation">(</span></span>
<span class="line">      context<span class="token punctuation">,</span></span>
<span class="line">      vnodeTag<span class="token punctuation">,</span></span>
<span class="line">      vnodeProps<span class="token punctuation">,</span></span>
<span class="line">      vnodeChildren<span class="token punctuation">,</span></span>
<span class="line">      patchFlag<span class="token punctuation">,</span></span>
<span class="line">      dynamicProps<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è·å–è¡¥ä¸æ ‡å¿—</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getPatchFlag</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span> context<span class="token operator">:</span> TransformContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> patchFlag <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ£€æŸ¥åŠ¨æ€å±æ€§</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> prop <span class="token keyword">of</span> node<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> dir <span class="token operator">=</span> prop</span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;bind&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">PROPS</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;on&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">HYDRATE_EVENTS</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;class&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">CLASS</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">STYLE</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ£€æŸ¥åŠ¨æ€å­èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">TEXT</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> patchFlag</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-å—çº§ä¼˜åŒ–-block-optimization" tabindex="-1"><a class="header-anchor" href="#_4-å—çº§ä¼˜åŒ–-block-optimization"><span>4. å—çº§ä¼˜åŒ– (Block Optimization)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// å—çº§ä¼˜åŒ–è½¬æ¢å™¨</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> transformBlock<span class="token operator">:</span> <span class="token function-variable function">NodeTransform</span> <span class="token operator">=</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">!==</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ£€æŸ¥æ˜¯å¦ä¸ºå—çº§èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasDynamicChildren</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ ‡è®°ä¸ºå—çº§èŠ‚ç‚¹</span></span>
<span class="line">    context<span class="token punctuation">.</span><span class="token function">replaceNode</span><span class="token punctuation">(</span><span class="token function">createBlock</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨æ€å­èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">hasDynamicChildren</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ElementNode<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasDynamicProps</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasDynamicChildren</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// åˆ›å»ºå—çº§èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createBlock</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span> context<span class="token operator">:</span> TransformContext<span class="token punctuation">)</span><span class="token operator">:</span> VNodeCall <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children <span class="token punctuation">}</span> <span class="token operator">=</span> node</span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">createVNodeCall</span><span class="token punctuation">(</span></span>
<span class="line">    context<span class="token punctuation">,</span></span>
<span class="line">    <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">buildProps</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">buildChildren</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">getPatchFlag</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">getDynamicProps</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// isBlock</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ¨-ä»£ç ç”Ÿæˆ-codegen" tabindex="-1"><a class="header-anchor" href="#ğŸ¨-ä»£ç ç”Ÿæˆ-codegen"><span>ğŸ¨ ä»£ç ç”Ÿæˆ (Codegen)</span></a></h2><h3 id="_1-ä»£ç ç”Ÿæˆå™¨" tabindex="-1"><a class="header-anchor" href="#_1-ä»£ç ç”Ÿæˆå™¨"><span>1. ä»£ç ç”Ÿæˆå™¨</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// ä»£ç ç”Ÿæˆä¸Šä¸‹æ–‡</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">CodegenContext</span> <span class="token punctuation">{</span></span>
<span class="line">  source<span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  code<span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  line<span class="token operator">:</span> <span class="token builtin">number</span></span>
<span class="line">  column<span class="token operator">:</span> <span class="token builtin">number</span></span>
<span class="line">  offset<span class="token operator">:</span> <span class="token builtin">number</span></span>
<span class="line">  indentLevel<span class="token operator">:</span> <span class="token builtin">number</span></span>
<span class="line">  <span class="token function">push</span><span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> node<span class="token operator">?</span><span class="token operator">:</span> Node<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">indent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">deindent</span><span class="token punctuation">(</span>withoutNewLine<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">newline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä»£ç ç”Ÿæˆç»“æœ</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">CodegenResult</span> <span class="token punctuation">{</span></span>
<span class="line">  code<span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  preamble<span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  ast<span class="token operator">:</span> RootNode</span>
<span class="line">  map<span class="token operator">?</span><span class="token operator">:</span> RawSourceMap</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç”Ÿæˆä»£ç </span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">generate</span><span class="token punctuation">(</span></span>
<span class="line">  ast<span class="token operator">:</span> RootNode<span class="token punctuation">,</span></span>
<span class="line">  options<span class="token operator">:</span> CodegenOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> CodegenResult <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createCodegenContext</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> mode<span class="token punctuation">,</span> push<span class="token punctuation">,</span> prefixIdentifiers <span class="token punctuation">}</span> <span class="token operator">=</span> context</span>
<span class="line">  <span class="token keyword">const</span> helpers <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>helpers<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">const</span> hasHelpers <span class="token operator">=</span> helpers<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// ç”Ÿæˆå‰å¯¼ä»£ç </span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> <span class="token string">&#39;module&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">genModulePreamble</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token function">genScopeId</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">genFunctionPreamble</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// ç”Ÿæˆæ¸²æŸ“å‡½æ•°</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prefixIdentifiers <span class="token operator">&amp;&amp;</span> mode <span class="token operator">===</span> <span class="token string">&#39;module&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;function render(&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">genFunctionArguments</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;) {\\n&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;function render(&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">genFunctionArguments</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;) {\\n&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// ç”Ÿæˆå‡½æ•°ä½“</span></span>
<span class="line">  <span class="token function">genIndent</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span>
<span class="line">  <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;return &#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>codegenNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">genNode</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>codegenNode<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;null&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// ç»“æŸå‡½æ•°</span></span>
<span class="line">  context<span class="token punctuation">.</span><span class="token function">deindent</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;\\n}&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    code<span class="token operator">:</span> context<span class="token punctuation">.</span>code<span class="token punctuation">,</span></span>
<span class="line">    preamble<span class="token operator">:</span> context<span class="token punctuation">.</span>preamble<span class="token punctuation">,</span></span>
<span class="line">    ast<span class="token punctuation">,</span></span>
<span class="line">    map<span class="token operator">:</span> context<span class="token punctuation">.</span>map <span class="token operator">?</span> context<span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-èŠ‚ç‚¹ä»£ç ç”Ÿæˆ" tabindex="-1"><a class="header-anchor" href="#_2-èŠ‚ç‚¹ä»£ç ç”Ÿæˆ"><span>2. èŠ‚ç‚¹ä»£ç ç”Ÿæˆ</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// ç”ŸæˆèŠ‚ç‚¹ä»£ç </span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">genNode</span><span class="token punctuation">(</span>node<span class="token operator">:</span> CodegenNode<span class="token punctuation">,</span> context<span class="token operator">:</span> CodegenContext<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">IF</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">FOR</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>codegenNode<span class="token operator">!</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genText</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genInterpolation</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT_CALL</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genTextCall</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMPOUND_EXPRESSION</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genCompoundExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMMENT</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genComment</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">VNODE_CALL</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genVNodeCall</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_CALL_EXPRESSION</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genCallExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_OBJECT_EXPRESSION</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genObjectExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_PROPERTY</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genProperty</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_ARRAY_EXPRESSION</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genArrayExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_FUNCTION_EXPRESSION</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genFunctionExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_CONDITIONAL_EXPRESSION</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genConditionalExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_CACHE_EXPRESSION</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genCacheExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_BLOCK_STATEMENT</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genBlockStatement</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_TEMPLATE_LITERAL</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genTemplateLiteral</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_IF_STATEMENT</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genIfStatement</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_ASSIGNMENT_EXPRESSION</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genAssignmentExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_SEQUENCE_EXPRESSION</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genSequenceExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">JS_RETURN_STATEMENT</span><span class="token operator">:</span></span>
<span class="line">      <span class="token function">genReturnStatement</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç”ŸæˆVNodeè°ƒç”¨</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">genVNodeCall</span><span class="token punctuation">(</span>node<span class="token operator">:</span> VNodeCall<span class="token punctuation">,</span> context<span class="token operator">:</span> CodegenContext<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> push<span class="token punctuation">,</span> helper<span class="token punctuation">,</span> pure <span class="token punctuation">}</span> <span class="token operator">=</span> context</span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">    tag<span class="token punctuation">,</span></span>
<span class="line">    props<span class="token punctuation">,</span></span>
<span class="line">    children<span class="token punctuation">,</span></span>
<span class="line">    patchFlag<span class="token punctuation">,</span></span>
<span class="line">    dynamicProps<span class="token punctuation">,</span></span>
<span class="line">    directives<span class="token punctuation">,</span></span>
<span class="line">    isBlock<span class="token punctuation">,</span></span>
<span class="line">    disableTracking<span class="token punctuation">,</span></span>
<span class="line">    isComponent<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token operator">=</span> node</span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>directives<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">WITH_DIRECTIVES</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;(&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>isBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">OPEN_BLOCK</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>disableTracking <span class="token operator">?</span> <span class="token string">&#39;true&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">), </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>pure<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">PURE_ANNOTATION</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">RESOLVE_COMPONENT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">CREATE_ELEMENT_VNODE</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;, &#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">genNode</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;, null&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;, &#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">genNodeList</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">genNode</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;, null&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;, &#39;</span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>patchFlag<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamicProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;, &#39;</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dynamicProps<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>isBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>directives<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;, &#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">genNode</span><span class="token punctuation">(</span>directives<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-ä¼˜åŒ–ä»£ç ç”Ÿæˆ" tabindex="-1"><a class="header-anchor" href="#_3-ä¼˜åŒ–ä»£ç ç”Ÿæˆ"><span>3. ä¼˜åŒ–ä»£ç ç”Ÿæˆ</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// ç”Ÿæˆä¼˜åŒ–ä»£ç </span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">genOptimizedCode</span><span class="token punctuation">(</span>ast<span class="token operator">:</span> RootNode<span class="token punctuation">,</span> context<span class="token operator">:</span> CodegenContext<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ç”Ÿæˆé™æ€æå‡</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>hoists<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;const &#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ast<span class="token punctuation">.</span>hoists<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;, &#39;</span><span class="token punctuation">)</span></span>
<span class="line">      context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">_hoisted_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39; = &#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ast<span class="token punctuation">.</span>hoists<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;, &#39;</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token function">genNode</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>hoists<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// ç”Ÿæˆç¼“å­˜</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>cached<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;const &#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ast<span class="token punctuation">.</span>cached<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;, &#39;</span><span class="token punctuation">)</span></span>
<span class="line">      context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">_cached_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39; = &#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ast<span class="token punctuation">.</span>cached<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;, &#39;</span><span class="token punctuation">)</span></span>
<span class="line">      context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">CACHE</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token function">genNode</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>cached<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">      context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”§-ç¼–è¯‘å™¨ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-ç¼–è¯‘å™¨ä¼˜åŒ–"><span>ğŸ”§ ç¼–è¯‘å™¨ä¼˜åŒ–</span></a></h2><h3 id="_1-ç¼–è¯‘æ—¶ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_1-ç¼–è¯‘æ—¶ä¼˜åŒ–"><span>1. ç¼–è¯‘æ—¶ä¼˜åŒ–</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// ç¼–è¯‘å™¨é€‰é¡¹</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">CompilerOptions</span> <span class="token punctuation">{</span></span>
<span class="line">  mode<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">&#39;module&#39;</span> <span class="token operator">|</span> <span class="token string">&#39;function&#39;</span> <span class="token comment">// ç¼–è¯‘æ¨¡å¼</span></span>
<span class="line">  prefixIdentifiers<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">// å‰ç¼€æ ‡è¯†ç¬¦</span></span>
<span class="line">  hoistStatic<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">// é™æ€æå‡</span></span>
<span class="line">  cacheHandlers<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">// ç¼“å­˜å¤„ç†å™¨</span></span>
<span class="line">  scopeId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token comment">// ä½œç”¨åŸŸID</span></span>
<span class="line">  slotted<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">// æ’æ§½</span></span>
<span class="line">  ssr<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">// æœåŠ¡ç«¯æ¸²æŸ“</span></span>
<span class="line">  isNativeTag<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>tag<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span> <span class="token comment">// åŸç”Ÿæ ‡ç­¾æ£€æŸ¥</span></span>
<span class="line">  isBuiltInComponent<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>tag<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">symbol</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token comment">// å†…ç½®ç»„ä»¶æ£€æŸ¥</span></span>
<span class="line">  delimiters<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">]</span> <span class="token comment">// åˆ†éš”ç¬¦</span></span>
<span class="line">  comments<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">// ä¿ç•™æ³¨é‡Š</span></span>
<span class="line">  whitespace<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">&#39;preserve&#39;</span> <span class="token operator">|</span> <span class="token string">&#39;condense&#39;</span> <span class="token comment">// ç©ºç™½å¤„ç†</span></span>
<span class="line">  bindingMetadata<span class="token operator">?</span><span class="token operator">:</span> BindingMetadata <span class="token comment">// ç»‘å®šå…ƒæ•°æ®</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç¼–è¯‘ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span></span>
<span class="line">  source<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> RootNode<span class="token punctuation">,</span></span>
<span class="line">  options<span class="token operator">:</span> CompilerOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> CodegenResult <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">baseParse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">:</span> source</span>
<span class="line"></span>
<span class="line">  <span class="token comment">// åº”ç”¨è½¬æ¢</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">[</span>nodeTransforms<span class="token punctuation">,</span> directiveTransforms<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getBaseTransformPreset</span><span class="token punctuation">(</span></span>
<span class="line">    options<span class="token punctuation">.</span>prefixIdentifiers<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">transform</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token operator">...</span>options<span class="token punctuation">,</span></span>
<span class="line">    nodeTransforms<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>nodeTransforms<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>nodeTransforms <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    directiveTransforms<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token operator">...</span>directiveTransforms<span class="token punctuation">,</span></span>
<span class="line">      <span class="token operator">...</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>directiveTransforms <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// ç”Ÿæˆä»£ç </span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token operator">...</span>options<span class="token punctuation">,</span></span>
<span class="line">    mode<span class="token operator">:</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-è¿è¡Œæ—¶ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_2-è¿è¡Œæ—¶ä¼˜åŒ–"><span>2. è¿è¡Œæ—¶ä¼˜åŒ–</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// è¿è¡Œæ—¶ä¼˜åŒ–æ ‡å¿—</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> RuntimeFlags <span class="token punctuation">{</span></span>
<span class="line">  <span class="token constant">OPEN_BLOCK</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">CREATE_ELEMENT_VNODE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">CREATE_VNODE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">CREATE_COMMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">CREATE_TEXT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">CREATE_STATIC</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">RESOLVE_COMPONENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">RESOLVE_DIRECTIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">WITH_DIRECTIVES</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">RENDER_LIST</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">RENDER_SLOT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">TO_STRING</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">TO_DISPLAY_STRING</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">INTERPOLATE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">SET_BLOCK_TRACKING</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">PUSH_SCOPE_ID</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">15</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">POP_SCOPE_ID</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">WITH_CTX</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">17</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">UNREF</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">18</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">IS_REF</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">19</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">WITH_MEMO</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">IS_MEMO_SAME</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">21</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¿è¡Œæ—¶åŠ©æ‰‹</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> helperNameMap<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">symbol</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">OPEN_BLOCK</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;openBlock&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">CREATE_ELEMENT_VNODE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;createElementVNode&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">CREATE_VNODE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;createVNode&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">CREATE_COMMENT</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;createCommentVNode&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">CREATE_TEXT</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;createTextVNode&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">CREATE_STATIC</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;createStaticVNode&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">RESOLVE_COMPONENT</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;resolveComponent&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">RESOLVE_DIRECTIVE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;resolveDirective&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">WITH_DIRECTIVES</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;withDirectives&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">RENDER_LIST</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;renderList&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">RENDER_SLOT</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;renderSlot&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">TO_STRING</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;toString&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">TO_DISPLAY_STRING</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;toDisplayString&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">INTERPOLATE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;interpolate&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">SET_BLOCK_TRACKING</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;setBlockTracking&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">PUSH_SCOPE_ID</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;pushScopeId&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">POP_SCOPE_ID</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;popScopeId&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">WITH_CTX</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;withCtx&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">UNREF</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;unref&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">IS_REF</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;isRef&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">WITH_MEMO</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;withMemo&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token constant">IS_MEMO_SAME</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&#39;isMemoSame&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“Š-æ€§èƒ½ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-æ€§èƒ½ä¼˜åŒ–"><span>ğŸ“Š æ€§èƒ½ä¼˜åŒ–</span></a></h2><h3 id="_1-ç¼–è¯‘æ—¶ä¼˜åŒ–ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#_1-ç¼–è¯‘æ—¶ä¼˜åŒ–ç­–ç•¥"><span>1. ç¼–è¯‘æ—¶ä¼˜åŒ–ç­–ç•¥</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// é™æ€æå‡ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">const</span> hoisted <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&#39;static&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¡¥ä¸æ ‡å¿—ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">const</span> patchFlag <span class="token operator">=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">CLASS</span> <span class="token operator">|</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">STYLE</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å—çº§ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">const</span> dynamicChildren <span class="token operator">=</span> <span class="token punctuation">[</span>dynamicVNode1<span class="token punctuation">,</span> dynamicVNode2<span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç¼“å­˜ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">const</span> cached <span class="token operator">=</span> <span class="token function">_cache</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">expensiveComputation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-è¿è¡Œæ—¶ä¼˜åŒ–ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#_2-è¿è¡Œæ—¶ä¼˜åŒ–ç­–ç•¥"><span>2. è¿è¡Œæ—¶ä¼˜åŒ–ç­–ç•¥</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// å¿«é€Ÿè·¯å¾„æ£€æŸ¥</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// æœ‰è¡¥ä¸æ ‡å¿—ï¼Œè¿›è¡Œä¼˜åŒ–æ›´æ–°</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">CLASS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åªæ›´æ–°ç±»å</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">STYLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åªæ›´æ–°æ ·å¼</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// æ— è¡¥ä¸æ ‡å¿—ï¼Œå…¨é‡æ›´æ–°</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å—çº§æ›´æ–°</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>dynamicChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// åªæ›´æ–°åŠ¨æ€å­èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dynamicChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">patch</span><span class="token punctuation">(</span>dynamicChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> newDynamicChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ¯-æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-æ€»ç»“"><span>ğŸ¯ æ€»ç»“</span></a></h2><p>Vue3çš„ç¼–è¯‘å™¨ç³»ç»Ÿå±•ç°äº†ç°ä»£å‰ç«¯æ¡†æ¶çš„è®¾è®¡ç²¾é«“ï¼š</p><ol><li><strong>é«˜æ•ˆè§£æ</strong> - è¯æ³•åˆ†æ + è¯­æ³•åˆ†æ + ASTç”Ÿæˆ</li><li><strong>æ™ºèƒ½è½¬æ¢</strong> - é™æ€æå‡ + è¡¥ä¸æ ‡å¿— + å—çº§ä¼˜åŒ–</li><li><strong>ä¼˜åŒ–ç”Ÿæˆ</strong> - æ¸²æŸ“å‡½æ•° + ä¼˜åŒ–ä»£ç  + æºç æ˜ å°„</li><li><strong>ç¼–è¯‘æ—¶ä¼˜åŒ–</strong> - å¤šç§ä¼˜åŒ–ç­–ç•¥ç»„åˆ</li><li><strong>è¿è¡Œæ—¶ä¼˜åŒ–</strong> - å¿«é€Ÿè·¯å¾„ + å—çº§æ›´æ–°</li><li><strong>è·¨å¹³å°æ”¯æŒ</strong> - æ¨¡å—åŒ– + å¯æ‰©å±•</li></ol><p>è¿™å¥—ç¼–è¯‘å™¨ç³»ç»Ÿä¸ä»…ä¸ºVue3æä¾›äº†é«˜æ•ˆçš„ç¼–è¯‘èƒ½åŠ›ï¼Œä¹Ÿä¸ºå…¶ä»–å‰ç«¯é¡¹ç›®æä¾›äº†ä¼˜ç§€çš„è®¾è®¡å‚è€ƒã€‚</p>`,42)]))}const i=s(e,[["render",o]]),u=JSON.parse('{"path":"/04-compiler-system.html","title":"Vue3ç¼–è¯‘å™¨ç³»ç»Ÿè¯¦è§£","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"ğŸ¯ ç¼–è¯‘å™¨æ¦‚è¿°","slug":"ğŸ¯-ç¼–è¯‘å™¨æ¦‚è¿°","link":"#ğŸ¯-ç¼–è¯‘å™¨æ¦‚è¿°","children":[{"level":3,"title":"ç¼–è¯‘å™¨æ¶æ„å›¾","slug":"ç¼–è¯‘å™¨æ¶æ„å›¾","link":"#ç¼–è¯‘å™¨æ¶æ„å›¾","children":[]}]},{"level":2,"title":"ğŸ” è§£æé˜¶æ®µ (Parse)","slug":"ğŸ”-è§£æé˜¶æ®µ-parse","link":"#ğŸ”-è§£æé˜¶æ®µ-parse","children":[{"level":3,"title":"1. è¯æ³•åˆ†æ (Lexical Analysis)","slug":"_1-è¯æ³•åˆ†æ-lexical-analysis","link":"#_1-è¯æ³•åˆ†æ-lexical-analysis","children":[]},{"level":3,"title":"2. è¯­æ³•åˆ†æ (Syntax Analysis)","slug":"_2-è¯­æ³•åˆ†æ-syntax-analysis","link":"#_2-è¯­æ³•åˆ†æ-syntax-analysis","children":[]},{"level":3,"title":"3. ASTèŠ‚ç‚¹ç±»å‹","slug":"_3-astèŠ‚ç‚¹ç±»å‹","link":"#_3-astèŠ‚ç‚¹ç±»å‹","children":[]}]},{"level":2,"title":"ğŸ”„ è½¬æ¢é˜¶æ®µ (Transform)","slug":"ğŸ”„-è½¬æ¢é˜¶æ®µ-transform","link":"#ğŸ”„-è½¬æ¢é˜¶æ®µ-transform","children":[{"level":3,"title":"1. è½¬æ¢å™¨æ¶æ„","slug":"_1-è½¬æ¢å™¨æ¶æ„","link":"#_1-è½¬æ¢å™¨æ¶æ„","children":[]},{"level":3,"title":"2. é™æ€æå‡ (Static Hoisting)","slug":"_2-é™æ€æå‡-static-hoisting","link":"#_2-é™æ€æå‡-static-hoisting","children":[]},{"level":3,"title":"3. è¡¥ä¸æ ‡å¿— (Patch Flags)","slug":"_3-è¡¥ä¸æ ‡å¿—-patch-flags","link":"#_3-è¡¥ä¸æ ‡å¿—-patch-flags","children":[]},{"level":3,"title":"4. å—çº§ä¼˜åŒ– (Block Optimization)","slug":"_4-å—çº§ä¼˜åŒ–-block-optimization","link":"#_4-å—çº§ä¼˜åŒ–-block-optimization","children":[]}]},{"level":2,"title":"ğŸ¨ ä»£ç ç”Ÿæˆ (Codegen)","slug":"ğŸ¨-ä»£ç ç”Ÿæˆ-codegen","link":"#ğŸ¨-ä»£ç ç”Ÿæˆ-codegen","children":[{"level":3,"title":"1. ä»£ç ç”Ÿæˆå™¨","slug":"_1-ä»£ç ç”Ÿæˆå™¨","link":"#_1-ä»£ç ç”Ÿæˆå™¨","children":[]},{"level":3,"title":"2. èŠ‚ç‚¹ä»£ç ç”Ÿæˆ","slug":"_2-èŠ‚ç‚¹ä»£ç ç”Ÿæˆ","link":"#_2-èŠ‚ç‚¹ä»£ç ç”Ÿæˆ","children":[]},{"level":3,"title":"3. ä¼˜åŒ–ä»£ç ç”Ÿæˆ","slug":"_3-ä¼˜åŒ–ä»£ç ç”Ÿæˆ","link":"#_3-ä¼˜åŒ–ä»£ç ç”Ÿæˆ","children":[]}]},{"level":2,"title":"ğŸ”§ ç¼–è¯‘å™¨ä¼˜åŒ–","slug":"ğŸ”§-ç¼–è¯‘å™¨ä¼˜åŒ–","link":"#ğŸ”§-ç¼–è¯‘å™¨ä¼˜åŒ–","children":[{"level":3,"title":"1. ç¼–è¯‘æ—¶ä¼˜åŒ–","slug":"_1-ç¼–è¯‘æ—¶ä¼˜åŒ–","link":"#_1-ç¼–è¯‘æ—¶ä¼˜åŒ–","children":[]},{"level":3,"title":"2. è¿è¡Œæ—¶ä¼˜åŒ–","slug":"_2-è¿è¡Œæ—¶ä¼˜åŒ–","link":"#_2-è¿è¡Œæ—¶ä¼˜åŒ–","children":[]}]},{"level":2,"title":"ğŸ“Š æ€§èƒ½ä¼˜åŒ–","slug":"ğŸ“Š-æ€§èƒ½ä¼˜åŒ–","link":"#ğŸ“Š-æ€§èƒ½ä¼˜åŒ–","children":[{"level":3,"title":"1. ç¼–è¯‘æ—¶ä¼˜åŒ–ç­–ç•¥","slug":"_1-ç¼–è¯‘æ—¶ä¼˜åŒ–ç­–ç•¥","link":"#_1-ç¼–è¯‘æ—¶ä¼˜åŒ–ç­–ç•¥","children":[]},{"level":3,"title":"2. è¿è¡Œæ—¶ä¼˜åŒ–ç­–ç•¥","slug":"_2-è¿è¡Œæ—¶ä¼˜åŒ–ç­–ç•¥","link":"#_2-è¿è¡Œæ—¶ä¼˜åŒ–ç­–ç•¥","children":[]}]},{"level":2,"title":"ğŸ¯ æ€»ç»“","slug":"ğŸ¯-æ€»ç»“","link":"#ğŸ¯-æ€»ç»“","children":[]}],"git":{"updatedTime":1754567332000,"contributors":[{"name":"atian","username":"atian","email":"atian@micous.com","commits":1,"url":"https://github.com/atian"}],"changelog":[{"hash":"fc80bf956ce2f65021db3835863d30f81c328ee4","time":1754567332000,"email":"atian@micous.com","author":"atian","message":"æ›´æ–°GitHub Actionsæ–‡æ¡£ï¼Œæ·»åŠ ä»£ç å—æ ¼å¼åŒ–ï¼Œè¡¥å……ç›¸å…³é“¾æ¥ï¼Œå¹¶åœ¨VuePressé…ç½®ä¸­æ–°å¢Vue3æ ¸å¿ƒçŸ¥è¯†çš„å¯¼èˆªå’Œä¾§è¾¹æ ï¼Œä¼˜åŒ–é¡µé¢è·¯ç”±è®¾ç½®ã€‚"}]},"filePathRelative":"04-compiler-system.md"}');export{i as comp,u as data};

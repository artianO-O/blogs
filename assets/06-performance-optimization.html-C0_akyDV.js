import{_ as s,c as a,a as p,o as e}from"./app-BssVU5rO.js";const t={};function l(c,n){return e(),a("div",null,n[0]||(n[0]=[p(`<h1 id="vue3æ€§èƒ½ä¼˜åŒ–è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#vue3æ€§èƒ½ä¼˜åŒ–è¯¦è§£"><span>Vue3æ€§èƒ½ä¼˜åŒ–è¯¦è§£</span></a></h1><h2 id="ğŸ¯-æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°"><span>ğŸ¯ æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°</span></a></h2><p>Vue3åœ¨æ€§èƒ½ä¼˜åŒ–æ–¹é¢åšäº†å¤§é‡å·¥ä½œï¼Œä»ç¼–è¯‘æ—¶åˆ°è¿è¡Œæ—¶éƒ½æœ‰ç›¸åº”çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå®ç°äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚</p><h3 id="ä¼˜åŒ–æ¶æ„å›¾" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–æ¶æ„å›¾"><span>ä¼˜åŒ–æ¶æ„å›¾</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚        ç¼–è¯‘æ—¶ä¼˜åŒ– (Compile-time)    â”‚</span>
<span class="line">â”‚  é™æ€æå‡ | è¡¥ä¸æ ‡å¿— | å—çº§ä¼˜åŒ–     â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚        è¿è¡Œæ—¶ä¼˜åŒ– (Runtime)         â”‚</span>
<span class="line">â”‚  å¿«é€Ÿè·¯å¾„ | æ‰¹é‡æ›´æ–° | ç¼“å­˜æœºåˆ¶     â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚        å†…å­˜ä¼˜åŒ– (Memory)            â”‚</span>
<span class="line">â”‚  WeakMap | è‡ªåŠ¨GC | å†…å­˜æ³„æ¼é˜²æŠ¤    â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”§-ç¼–è¯‘æ—¶ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-ç¼–è¯‘æ—¶ä¼˜åŒ–"><span>ğŸ”§ ç¼–è¯‘æ—¶ä¼˜åŒ–</span></a></h2><h3 id="_1-é™æ€æå‡-static-hoisting" tabindex="-1"><a class="header-anchor" href="#_1-é™æ€æå‡-static-hoisting"><span>1. é™æ€æå‡ (Static Hoisting)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// é™æ€èŠ‚ç‚¹æå‡</span></span>
<span class="line"><span class="token keyword">const</span> hoisted <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createVNode</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&#39;static-class&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    id<span class="token operator">:</span> <span class="token string">&#39;static-id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&#39;é™æ€å†…å®¹&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç¼–è¯‘ç»“æœ</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token function">openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">createElementBlock</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span></span>
<span class="line">      hoisted<span class="token punctuation">,</span> <span class="token comment">// å¤ç”¨é™æ€èŠ‚ç‚¹</span></span>
<span class="line">      <span class="token function">createElementVNode</span><span class="token punctuation">(</span><span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// é™æ€æå‡ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">transformHoist</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span> context<span class="token operator">:</span> TransformContext<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStaticNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æå‡é™æ€èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token keyword">const</span> hoisted <span class="token operator">=</span> <span class="token function">generateStaticNode</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">    context<span class="token punctuation">.</span><span class="token function">hoist</span><span class="token punctuation">(</span>hoisted<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// æ›¿æ¢ä¸ºé™æ€å¼•ç”¨</span></span>
<span class="line">    context<span class="token punctuation">.</span><span class="token function">replaceNode</span><span class="token punctuation">(</span></span>
<span class="line">      <span class="token function">createSimpleExpression</span><span class="token punctuation">(</span></span>
<span class="line">        context<span class="token punctuation">.</span><span class="token function">helperString</span><span class="token punctuation">(</span>HoistType<span class="token punctuation">.</span><span class="token constant">HOISTED</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">        node<span class="token punctuation">.</span>loc<span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ£€æŸ¥é™æ€èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">isStaticNode</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ElementNode<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// æ£€æŸ¥å±æ€§æ˜¯å¦é™æ€</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> prop <span class="token keyword">of</span> node<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isStaticExp</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ£€æŸ¥å­èŠ‚ç‚¹æ˜¯å¦é™æ€</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStaticChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-è¡¥ä¸æ ‡å¿—-patch-flags" tabindex="-1"><a class="header-anchor" href="#_2-è¡¥ä¸æ ‡å¿—-patch-flags"><span>2. è¡¥ä¸æ ‡å¿— (Patch Flags)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// è¡¥ä¸æ ‡å¿—å®šä¹‰</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> PatchFlags <span class="token punctuation">{</span></span>
<span class="line">  <span class="token constant">TEXT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€æ–‡æœ¬å†…å®¹</span></span>
<span class="line">  <span class="token constant">CLASS</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€ç±»å</span></span>
<span class="line">  <span class="token constant">STYLE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€æ ·å¼</span></span>
<span class="line">  <span class="token constant">PROPS</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€å±æ€§</span></span>
<span class="line">  <span class="token constant">FULL_PROPS</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// å…¨é‡å±æ€§æ›´æ–°</span></span>
<span class="line">  <span class="token constant">HYDRATE_EVENTS</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// æ°´åˆäº‹ä»¶</span></span>
<span class="line">  <span class="token constant">STABLE_FRAGMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token comment">// ç¨³å®šç‰‡æ®µ</span></span>
<span class="line">  <span class="token constant">KEYED_FRAGMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token comment">// å¸¦é”®çš„ç‰‡æ®µ</span></span>
<span class="line">  <span class="token constant">UNKEYED_FRAGMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// æ— é”®çš„ç‰‡æ®µ</span></span>
<span class="line">  <span class="token constant">NEED_PATCH</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token comment">// éœ€è¦è¡¥ä¸</span></span>
<span class="line">  <span class="token constant">DYNAMIC_SLOTS</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€æ’æ§½</span></span>
<span class="line">  <span class="token constant">HOISTED</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// é™æ€æå‡</span></span>
<span class="line">  <span class="token constant">BAIL</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// è·³è¿‡ä¼˜åŒ–</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç”Ÿæˆè¡¥ä¸æ ‡å¿—</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getPatchFlag</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ElementNode<span class="token punctuation">,</span> context<span class="token operator">:</span> TransformContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> patchFlag <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ£€æŸ¥åŠ¨æ€å±æ€§</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> prop <span class="token keyword">of</span> node<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">DIRECTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> dir <span class="token operator">=</span> prop</span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;bind&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">PROPS</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;on&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">HYDRATE_EVENTS</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ATTRIBUTE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;class&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">CLASS</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">STYLE</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ£€æŸ¥åŠ¨æ€å­èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> child <span class="token keyword">of</span> node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      patchFlag <span class="token operator">|=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">TEXT</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> patchFlag</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¿è¡Œæ—¶ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">patchElement</span><span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode<span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> patchFlag <span class="token punctuation">}</span> <span class="token operator">=</span> n2</span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æœ‰è¡¥ä¸æ ‡å¿—ï¼Œè¿›è¡Œä¼˜åŒ–æ›´æ–°</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">CLASS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// åªæ›´æ–°ç±»å</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>n1<span class="token punctuation">.</span>props<span class="token punctuation">.</span>class <span class="token operator">!==</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>class<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">hostPatchProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">&#39;class&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>class<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">STYLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// åªæ›´æ–°æ ·å¼</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>n1<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style <span class="token operator">!==</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">hostPatchProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">,</span> n1<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// åªæ›´æ–°æ–‡æœ¬å†…å®¹</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>n1<span class="token punctuation">.</span>children <span class="token operator">!==</span> n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">hostSetElementText</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ— è¡¥ä¸æ ‡å¿—ï¼Œå…¨é‡æ›´æ–°</span></span>
<span class="line">    <span class="token function">patchProps</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> n1<span class="token punctuation">.</span>props<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-å—çº§ä¼˜åŒ–-block-optimization" tabindex="-1"><a class="header-anchor" href="#_3-å—çº§ä¼˜åŒ–-block-optimization"><span>3. å—çº§ä¼˜åŒ– (Block Optimization)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// å—çº§èŠ‚ç‚¹æ¦‚å¿µ</span></span>
<span class="line"><span class="token keyword">let</span> currentBlock<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¼€å¯å—çº§è¿½è¸ª</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">openBlock</span><span class="token punctuation">(</span>disableTracking <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disableTracking<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    currentBlock <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å…³é—­å—çº§è¿½è¸ª</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">closeBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">  currentBlock <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è®¾ç½®å—çº§èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">setupBlock</span><span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    vnode<span class="token punctuation">.</span>dynamicChildren <span class="token operator">=</span> currentBlock</span>
<span class="line">    currentBlock <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å—çº§ä¼˜åŒ–ç¤ºä¾‹</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token function">openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">createElementBlock</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token function">createElementVNode</span><span class="token punctuation">(</span><span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// TEXT</span></span>
<span class="line">      <span class="token function">createElementVNode</span><span class="token punctuation">(</span><span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// TEXT</span></span>
<span class="line">      <span class="token function">createElementVNode</span><span class="token punctuation">(</span><span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&#39;é™æ€æ–‡æœ¬&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// é™æ€èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¿è¡Œæ—¶å—çº§æ›´æ–°</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">patchBlockChildren</span><span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode<span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> dynamicChildren <span class="token punctuation">}</span> <span class="token operator">=</span> n2</span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamicChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åªæ›´æ–°åŠ¨æ€å­èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dynamicChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> dynamicChild <span class="token operator">=</span> dynamicChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">      <span class="token keyword">const</span> child <span class="token operator">=</span> n1<span class="token punctuation">.</span>dynamicChildren<span class="token operator">!</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">      <span class="token function">patch</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> dynamicChild<span class="token punctuation">,</span> container<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å…¨é‡æ›´æ–°</span></span>
<span class="line">    <span class="token function">patchChildren</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="âš¡-è¿è¡Œæ—¶ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#âš¡-è¿è¡Œæ—¶ä¼˜åŒ–"><span>âš¡ è¿è¡Œæ—¶ä¼˜åŒ–</span></a></h2><h3 id="_1-å¿«é€Ÿè·¯å¾„-fast-path" tabindex="-1"><a class="header-anchor" href="#_1-å¿«é€Ÿè·¯å¾„-fast-path"><span>1. å¿«é€Ÿè·¯å¾„ (Fast Path)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// å¿«é€Ÿè·¯å¾„æ£€æŸ¥</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">patchElement</span><span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode<span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> patchFlag <span class="token punctuation">}</span> <span class="token operator">=</span> n2</span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å¿«é€Ÿè·¯å¾„ï¼šæœ‰è¡¥ä¸æ ‡å¿—</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">CLASS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// åªæ›´æ–°ç±»å</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>n1<span class="token punctuation">.</span>props<span class="token punctuation">.</span>class <span class="token operator">!==</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>class<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">hostPatchProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">&#39;class&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>class<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">STYLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// åªæ›´æ–°æ ·å¼</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>n1<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style <span class="token operator">!==</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">hostPatchProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">,</span> n1<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// åªæ›´æ–°æ–‡æœ¬å†…å®¹</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>n1<span class="token punctuation">.</span>children <span class="token operator">!==</span> n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">hostSetElementText</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ…¢é€Ÿè·¯å¾„ï¼šå…¨é‡æ›´æ–°</span></span>
<span class="line">    <span class="token function">patchProps</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> n1<span class="token punctuation">.</span>props<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¿«é€ŸDiffç®—æ³•</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span>c1<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token operator">:</span> VNodeArrayChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">  <span class="token keyword">const</span> l2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length</span>
<span class="line">  <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span></span>
<span class="line">  <span class="token keyword">let</span> e2 <span class="token operator">=</span> l2 <span class="token operator">-</span> <span class="token number">1</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 1. ä»å¤´éƒ¨å¼€å§‹æ¯”è¾ƒ</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">const</span> n2 <span class="token operator">=</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode</span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">patch</span><span class="token punctuation">(</span></span>
<span class="line">        n1<span class="token punctuation">,</span></span>
<span class="line">        n2<span class="token punctuation">,</span></span>
<span class="line">        container<span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">        parentComponent<span class="token punctuation">,</span></span>
<span class="line">        parentSuspense<span class="token punctuation">,</span></span>
<span class="line">        namespace<span class="token punctuation">,</span></span>
<span class="line">        slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">        optimized<span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    i<span class="token operator">++</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 2. ä»å°¾éƒ¨å¼€å§‹æ¯”è¾ƒ</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">const</span> n2 <span class="token operator">=</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode</span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">patch</span><span class="token punctuation">(</span></span>
<span class="line">        n1<span class="token punctuation">,</span></span>
<span class="line">        n2<span class="token punctuation">,</span></span>
<span class="line">        container<span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">        parentComponent<span class="token punctuation">,</span></span>
<span class="line">        parentSuspense<span class="token punctuation">,</span></span>
<span class="line">        namespace<span class="token punctuation">,</span></span>
<span class="line">        slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">        optimized<span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    e1<span class="token operator">--</span></span>
<span class="line">    e2<span class="token operator">--</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 3. å¤„ç†æ–°å¢å’Œåˆ é™¤</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ–°å¢èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> nextPos <span class="token operator">=</span> e2 <span class="token operator">+</span> <span class="token number">1</span></span>
<span class="line">      <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextPos <span class="token operator">&lt;</span> l2 <span class="token operator">?</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span><span class="token punctuation">.</span>el <span class="token operator">:</span> parentAnchor</span>
<span class="line">      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">patch</span><span class="token punctuation">(</span></span>
<span class="line">          <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">          c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">,</span></span>
<span class="line">          container<span class="token punctuation">,</span></span>
<span class="line">          anchor<span class="token punctuation">,</span></span>
<span class="line">          parentComponent<span class="token punctuation">,</span></span>
<span class="line">          parentSuspense<span class="token punctuation">,</span></span>
<span class="line">          namespace<span class="token punctuation">,</span></span>
<span class="line">          slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">          optimized<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        i<span class="token operator">++</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åˆ é™¤èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">unmount</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">      i<span class="token operator">++</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å¤„ç†æœªçŸ¥åºåˆ—</span></span>
<span class="line">    <span class="token keyword">const</span> s1 <span class="token operator">=</span> i</span>
<span class="line">    <span class="token keyword">const</span> s2 <span class="token operator">=</span> i</span>
<span class="line">    <span class="token keyword">const</span> keyToNewIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å»ºç«‹æ–°èŠ‚ç‚¹çš„keyæ˜ å°„</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s2<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> nextChild <span class="token operator">=</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode</span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// æ›´æ–°å’Œç§»åŠ¨èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token keyword">let</span> patched <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    <span class="token keyword">const</span> toBePatched <span class="token operator">=</span> e2 <span class="token operator">-</span> s2 <span class="token operator">+</span> <span class="token number">1</span></span>
<span class="line">    <span class="token keyword">let</span> moved <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token keyword">let</span> maxNewIndexSoFar <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s1<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e1<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> prevChild <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>patched <span class="token operator">&gt;=</span> toBePatched<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">unmount</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">continue</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">let</span> newIndex</span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        newIndex <span class="token operator">=</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// æ— keyçš„èŠ‚ç‚¹ï¼Œéœ€è¦éå†æŸ¥æ‰¾</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> s2<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            newIndex <span class="token operator">=</span> j</span>
<span class="line">            <span class="token keyword">break</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">unmount</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">&gt;=</span> maxNewIndexSoFar<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          maxNewIndexSoFar <span class="token operator">=</span> newIndex</span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">          moved <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">patch</span><span class="token punctuation">(</span></span>
<span class="line">          prevChild<span class="token punctuation">,</span></span>
<span class="line">          c2<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">,</span></span>
<span class="line">          container<span class="token punctuation">,</span></span>
<span class="line">          <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">          parentComponent<span class="token punctuation">,</span></span>
<span class="line">          parentSuspense<span class="token punctuation">,</span></span>
<span class="line">          namespace<span class="token punctuation">,</span></span>
<span class="line">          slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">          optimized<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        patched<span class="token operator">++</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-æ‰¹é‡æ›´æ–°-batch-updates" tabindex="-1"><a class="header-anchor" href="#_2-æ‰¹é‡æ›´æ–°-batch-updates"><span>2. æ‰¹é‡æ›´æ–° (Batch Updates)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// æ‰¹é‡æ·±åº¦</span></span>
<span class="line"><span class="token keyword">let</span> batchDepth <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¼€å§‹æ‰¹é‡</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">startBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">  batchDepth<span class="token operator">++</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»“æŸæ‰¹é‡</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">endBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>batchDepth <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span>
<span class="line">  <span class="token keyword">let</span> error<span class="token operator">:</span> <span class="token builtin">unknown</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>batchedSub<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> e<span class="token operator">:</span> Subscriber <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> batchedSub</span>
<span class="line">    batchedSub <span class="token operator">=</span> <span class="token keyword">undefined</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> next<span class="token operator">:</span> Subscriber <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>next</span>
<span class="line">      e<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">undefined</span></span>
<span class="line">      e<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>EffectFlags<span class="token punctuation">.</span><span class="token constant">NOTIFIED</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> EffectFlags<span class="token punctuation">.</span><span class="token constant">ACTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token punctuation">;</span><span class="token punctuation">(</span>e <span class="token keyword">as</span> ReactiveEffect<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> error <span class="token operator">=</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      e <span class="token operator">=</span> next</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> error</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ‰¹é‡ä»»åŠ¡</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">batch</span><span class="token punctuation">(</span>sub<span class="token operator">:</span> Subscriber<span class="token punctuation">,</span> isComputed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">  sub<span class="token punctuation">.</span>flags <span class="token operator">|=</span> EffectFlags<span class="token punctuation">.</span><span class="token constant">NOTIFIED</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>isComputed<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// computed effectï¼šæ·»åŠ åˆ°computedé˜Ÿåˆ—</span></span>
<span class="line">    sub<span class="token punctuation">.</span>next <span class="token operator">=</span> batchedComputed</span>
<span class="line">    batchedComputed <span class="token operator">=</span> sub</span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ™®é€šeffectï¼šæ·»åŠ åˆ°æ™®é€šé˜Ÿåˆ—</span></span>
<span class="line">    sub<span class="token punctuation">.</span>next <span class="token operator">=</span> batchedSub</span>
<span class="line">    batchedSub <span class="token operator">=</span> sub</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-ç¼“å­˜æœºåˆ¶-caching" tabindex="-1"><a class="header-anchor" href="#_3-ç¼“å­˜æœºåˆ¶-caching"><span>3. ç¼“å­˜æœºåˆ¶ (Caching)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// è®¡ç®—å±æ€§ç¼“å­˜</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ComputedRefImpl<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Subscriber</span> <span class="token punctuation">{</span></span>
<span class="line">  _value<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token keyword">undefined</span></span>
<span class="line">  dep<span class="token operator">:</span> Dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span></span>
<span class="line">  flags<span class="token operator">:</span> EffectFlags <span class="token operator">=</span> EffectFlags<span class="token punctuation">.</span><span class="token constant">DIRTY</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">refreshComputed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// åªåœ¨éœ€è¦æ—¶é‡æ–°è®¡ç®—</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">|=</span> EffectFlags<span class="token punctuation">.</span><span class="token constant">DIRTY</span> <span class="token comment">// æ ‡è®°ä¸ºè„</span></span>
<span class="line">    <span class="token function">batch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// æ‰¹é‡æ›´æ–°</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç‰ˆæœ¬æ§åˆ¶ç¼“å­˜</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">isDirty</span><span class="token punctuation">(</span>sub<span class="token operator">:</span> Subscriber<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> link <span class="token operator">=</span> sub<span class="token punctuation">.</span>deps<span class="token punctuation">;</span> link<span class="token punctuation">;</span> link <span class="token operator">=</span> link<span class="token punctuation">.</span>nextDep<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦åŒ¹é…</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>link<span class="token punctuation">.</span>dep<span class="token punctuation">.</span>version <span class="token operator">!==</span> link<span class="token punctuation">.</span>version<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// æ£€æŸ¥computedä¾èµ–</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>link<span class="token punctuation">.</span>dep<span class="token punctuation">.</span>computed <span class="token operator">&amp;&amp;</span> <span class="token function">refreshComputed</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span>dep<span class="token punctuation">.</span>computed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¿«é€Ÿè·¯å¾„ç¼“å­˜</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>computed<span class="token punctuation">.</span>globalVersion <span class="token operator">===</span> globalVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> computed<span class="token punctuation">.</span>_value <span class="token comment">// è·³è¿‡è®¡ç®—</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ’¾-å†…å­˜ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ğŸ’¾-å†…å­˜ä¼˜åŒ–"><span>ğŸ’¾ å†…å­˜ä¼˜åŒ–</span></a></h2><h3 id="_1-weakmapé¿å…å†…å­˜æ³„æ¼" tabindex="-1"><a class="header-anchor" href="#_1-weakmapé¿å…å†…å­˜æ³„æ¼"><span>1. WeakMapé¿å…å†…å­˜æ³„æ¼</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// å…¨å±€ä¾èµ–æ˜ å°„è¡¨</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> targetMap<span class="token operator">:</span> WeakMap<span class="token operator">&lt;</span>object<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> Dep<span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// WeakMapçš„ä¼˜åŠ¿</span></span>
<span class="line"><span class="token comment">// 1. å½“targetè¢«GCæ—¶ï¼Œç›¸å…³ä¾èµ–è‡ªåŠ¨æ¸…ç†</span></span>
<span class="line"><span class="token comment">// 2. é¿å…å†…å­˜æ³„æ¼</span></span>
<span class="line"><span class="token comment">// 3. è‡ªåŠ¨åƒåœ¾å›æ”¶</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä¾èµ–æ”¶é›†</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token operator">:</span> object<span class="token punctuation">,</span> type<span class="token operator">:</span> TrackOpTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrack <span class="token operator">&amp;&amp;</span> activeSub<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è·å–æˆ–åˆ›å»ºtargetçš„ä¾èµ–æ˜ å°„</span></span>
<span class="line">    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// è·å–æˆ–åˆ›å»ºkeyçš„ä¾èµ–</span></span>
<span class="line">    <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">      dep<span class="token punctuation">.</span>map <span class="token operator">=</span> depsMap</span>
<span class="line">      dep<span class="token punctuation">.</span>key <span class="token operator">=</span> key</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å»ºç«‹ä¾èµ–å…³ç³»</span></span>
<span class="line">    dep<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-åŒå‘é“¾è¡¨o-1-æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#_2-åŒå‘é“¾è¡¨o-1-æ“ä½œ"><span>2. åŒå‘é“¾è¡¨O(1)æ“ä½œ</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// é“¾æ¥èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Link</span> <span class="token punctuation">{</span></span>
<span class="line">  version<span class="token operator">:</span> <span class="token builtin">number</span></span>
<span class="line">  nextDep<span class="token operator">?</span><span class="token operator">:</span> Link <span class="token comment">// åœ¨effectçš„depé“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª</span></span>
<span class="line">  prevDep<span class="token operator">?</span><span class="token operator">:</span> Link <span class="token comment">// åœ¨effectçš„depé“¾è¡¨ä¸­çš„ä¸Šä¸€ä¸ª</span></span>
<span class="line">  nextSub<span class="token operator">?</span><span class="token operator">:</span> Link <span class="token comment">// åœ¨depçš„subé“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª</span></span>
<span class="line">  prevSub<span class="token operator">?</span><span class="token operator">:</span> Link <span class="token comment">// åœ¨depçš„subé“¾è¡¨ä¸­çš„ä¸Šä¸€ä¸ª</span></span>
<span class="line">  prevActiveLink<span class="token operator">?</span><span class="token operator">:</span> Link</span>
<span class="line"></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">public</span> sub<span class="token operator">:</span> Subscriber<span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">public</span> dep<span class="token operator">:</span> Dep<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>version <span class="token operator">=</span> dep<span class="token punctuation">.</span>version</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// O(1)çš„ä¾èµ–ç®¡ç†æ“ä½œ</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">addDep</span><span class="token punctuation">(</span>sub<span class="token operator">:</span> Subscriber<span class="token punctuation">,</span> dep<span class="token operator">:</span> Dep<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> link <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Link</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span> dep<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ·»åŠ åˆ°depçš„subé“¾è¡¨</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dep<span class="token punctuation">.</span>subs<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    dep<span class="token punctuation">.</span>subs<span class="token punctuation">.</span>prevSub <span class="token operator">=</span> link</span>
<span class="line">    link<span class="token punctuation">.</span>nextSub <span class="token operator">=</span> dep<span class="token punctuation">.</span>subs</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  dep<span class="token punctuation">.</span>subs <span class="token operator">=</span> link</span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ·»åŠ åˆ°subçš„depé“¾è¡¨</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    sub<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>prevDep <span class="token operator">=</span> link</span>
<span class="line">    link<span class="token punctuation">.</span>nextDep <span class="token operator">=</span> sub<span class="token punctuation">.</span>deps</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  sub<span class="token punctuation">.</span>deps <span class="token operator">=</span> link</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">removeDep</span><span class="token punctuation">(</span>link<span class="token operator">:</span> Link<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ä»depçš„subé“¾è¡¨ä¸­ç§»é™¤</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>link<span class="token punctuation">.</span>nextSub<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    link<span class="token punctuation">.</span>nextSub<span class="token punctuation">.</span>prevSub <span class="token operator">=</span> link<span class="token punctuation">.</span>prevSub</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>link<span class="token punctuation">.</span>prevSub<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    link<span class="token punctuation">.</span>prevSub<span class="token punctuation">.</span>nextSub <span class="token operator">=</span> link<span class="token punctuation">.</span>nextSub</span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    link<span class="token punctuation">.</span>dep<span class="token punctuation">.</span>subs <span class="token operator">=</span> link<span class="token punctuation">.</span>nextSub</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// ä»subçš„depé“¾è¡¨ä¸­ç§»é™¤</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>link<span class="token punctuation">.</span>nextDep<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    link<span class="token punctuation">.</span>nextDep<span class="token punctuation">.</span>prevDep <span class="token operator">=</span> link<span class="token punctuation">.</span>prevDep</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>link<span class="token punctuation">.</span>prevDep<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    link<span class="token punctuation">.</span>prevDep<span class="token punctuation">.</span>nextDep <span class="token operator">=</span> link<span class="token punctuation">.</span>nextDep</span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    link<span class="token punctuation">.</span>sub<span class="token punctuation">.</span>deps <span class="token operator">=</span> link<span class="token punctuation">.</span>nextDep</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-ä¾èµ–æ¸…ç†æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_3-ä¾èµ–æ¸…ç†æœºåˆ¶"><span>3. ä¾èµ–æ¸…ç†æœºåˆ¶</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// ä¾èµ–æ¸…ç†</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">cleanupDeps</span><span class="token punctuation">(</span>sub<span class="token operator">:</span> Subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> head</span>
<span class="line">  <span class="token keyword">let</span> tail <span class="token operator">=</span> sub<span class="token punctuation">.</span>depsTail</span>
<span class="line">  <span class="token keyword">let</span> link <span class="token operator">=</span> tail</span>
<span class="line"></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>link<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> prev <span class="token operator">=</span> link<span class="token punctuation">.</span>prevDep</span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>link<span class="token punctuation">.</span>version <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// æœªä½¿ç”¨çš„ä¾èµ–ï¼šä»é“¾è¡¨ä¸­ç§»é™¤</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>link <span class="token operator">===</span> tail<span class="token punctuation">)</span> tail <span class="token operator">=</span> prev</span>
<span class="line">      <span class="token function">removeSub</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span></span>
<span class="line">      <span class="token function">removeDep</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// ä½¿ç”¨çš„ä¾èµ–ï¼šä¿ç•™</span></span>
<span class="line">      head <span class="token operator">=</span> link</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// æ¢å¤ä¹‹å‰çš„æ´»è·ƒé“¾æ¥</span></span>
<span class="line">    link<span class="token punctuation">.</span>dep<span class="token punctuation">.</span>activeLink <span class="token operator">=</span> link<span class="token punctuation">.</span>prevActiveLink</span>
<span class="line">    link<span class="token punctuation">.</span>prevActiveLink <span class="token operator">=</span> <span class="token keyword">undefined</span></span>
<span class="line">    link <span class="token operator">=</span> prev</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// æ›´æ–°å¤´éƒ¨å’Œå°¾éƒ¨æŒ‡é’ˆ</span></span>
<span class="line">  sub<span class="token punctuation">.</span>deps <span class="token operator">=</span> head</span>
<span class="line">  sub<span class="token punctuation">.</span>depsTail <span class="token operator">=</span> tail</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“Š-æ€§èƒ½ç›‘æ§" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-æ€§èƒ½ç›‘æ§"><span>ğŸ“Š æ€§èƒ½ç›‘æ§</span></a></h2><h3 id="_1-æ€§èƒ½æŒ‡æ ‡" tabindex="-1"><a class="header-anchor" href="#_1-æ€§èƒ½æŒ‡æ ‡"><span>1. æ€§èƒ½æŒ‡æ ‡</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// æ€§èƒ½ç›‘æ§</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PerformanceMetrics</span> <span class="token punctuation">{</span></span>
<span class="line">  renderTime<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">// æ¸²æŸ“æ—¶é—´</span></span>
<span class="line">  patchTime<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">// è¡¥ä¸æ—¶é—´</span></span>
<span class="line">  mountTime<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">// æŒ‚è½½æ—¶é—´</span></span>
<span class="line">  updateTime<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">// æ›´æ–°æ—¶é—´</span></span>
<span class="line">  memoryUsage<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">// å†…å­˜ä½¿ç”¨</span></span>
<span class="line">  componentCount<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">// ç»„ä»¶æ•°é‡</span></span>
<span class="line">  vnodeCount<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">// VNodeæ•°é‡</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ€§èƒ½ç›‘æ§å™¨</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">PerformanceMonitor</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">private</span> metrics<span class="token operator">:</span> PerformanceMetrics <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    renderTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    patchTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    mountTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    updateTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    memoryUsage<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    componentCount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    vnodeCount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">startTimer</span><span class="token punctuation">(</span>type<span class="token operator">:</span> <span class="token keyword">keyof</span> PerformanceMetrics<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>metrics<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">endTimer</span><span class="token punctuation">(</span>type<span class="token operator">:</span> <span class="token keyword">keyof</span> PerformanceMetrics<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metrics<span class="token punctuation">[</span>type<span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">const</span> endTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> duration <span class="token operator">=</span> endTime <span class="token operator">-</span> startTime</span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>metrics<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> duration</span>
<span class="line">    <span class="token keyword">return</span> duration</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> PerformanceMetrics <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>metrics <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-æ€§èƒ½åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_2-æ€§èƒ½åˆ†æ"><span>2. æ€§èƒ½åˆ†æ</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// æ€§èƒ½åˆ†æå·¥å…·</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">analyzePerformance</span><span class="token punctuation">(</span>app<span class="token operator">:</span> App<span class="token punctuation">)</span><span class="token operator">:</span> PerformanceReport <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> report<span class="token operator">:</span> PerformanceReport <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    totalRenderTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    averageRenderTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    slowestComponents<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    memoryLeaks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    optimizationSuggestions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// åˆ†ææ¸²æŸ“æ€§èƒ½</span></span>
<span class="line">  <span class="token keyword">const</span> components <span class="token operator">=</span> <span class="token function">getAllComponents</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> component <span class="token keyword">of</span> components<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> renderTime <span class="token operator">=</span> <span class="token function">getComponentRenderTime</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span></span>
<span class="line">    report<span class="token punctuation">.</span>totalRenderTime <span class="token operator">+=</span> renderTime</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>renderTime <span class="token operator">&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// è¶…è¿‡16msçš„ç»„ä»¶</span></span>
<span class="line">      report<span class="token punctuation">.</span>slowestComponents<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        name<span class="token operator">:</span> component<span class="token punctuation">.</span>type<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">        renderTime<span class="token punctuation">,</span></span>
<span class="line">        suggestions<span class="token operator">:</span> <span class="token function">getOptimizationSuggestions</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  report<span class="token punctuation">.</span>averageRenderTime <span class="token operator">=</span> report<span class="token punctuation">.</span>totalRenderTime <span class="token operator">/</span> components<span class="token punctuation">.</span>length</span>
<span class="line"></span>
<span class="line">  <span class="token comment">// åˆ†æå†…å­˜ä½¿ç”¨</span></span>
<span class="line">  <span class="token keyword">const</span> memoryUsage <span class="token operator">=</span> <span class="token function">getMemoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>memoryUsage <span class="token operator">&gt;</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è¶…è¿‡50MB</span></span>
<span class="line">    report<span class="token punctuation">.</span>memoryLeaks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      type<span class="token operator">:</span> <span class="token string">&#39;high_memory_usage&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      usage<span class="token operator">:</span> memoryUsage<span class="token punctuation">,</span></span>
<span class="line">      suggestions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;æ£€æŸ¥å†…å­˜æ³„æ¼&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ä¼˜åŒ–æ•°æ®ç»“æ„&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ä½¿ç”¨WeakMap&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> report</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ¯-ä¼˜åŒ–å»ºè®®" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-ä¼˜åŒ–å»ºè®®"><span>ğŸ¯ ä¼˜åŒ–å»ºè®®</span></a></h2><h3 id="_1-ç¼–è¯‘æ—¶ä¼˜åŒ–å»ºè®®" tabindex="-1"><a class="header-anchor" href="#_1-ç¼–è¯‘æ—¶ä¼˜åŒ–å»ºè®®"><span>1. ç¼–è¯‘æ—¶ä¼˜åŒ–å»ºè®®</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// 1. ä½¿ç”¨é™æ€æå‡</span></span>
<span class="line"><span class="token keyword">const</span> staticNode <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&#39;static&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. åˆç†ä½¿ç”¨è¡¥ä¸æ ‡å¿—</span></span>
<span class="line"><span class="token keyword">const</span> dynamicProps <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> computedClass<span class="token punctuation">,</span> style<span class="token operator">:</span> computedStyle <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 3. å—çº§ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">const</span> blockNode <span class="token operator">=</span> <span class="token function">createElementBlock</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span></span>
<span class="line">  <span class="token function">createElementVNode</span><span class="token punctuation">(</span><span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">toDisplayString</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 4. ç¼“å­˜ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">const</span> cachedValue <span class="token operator">=</span> <span class="token function">_cache</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">expensiveComputation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-è¿è¡Œæ—¶ä¼˜åŒ–å»ºè®®" tabindex="-1"><a class="header-anchor" href="#_2-è¿è¡Œæ—¶ä¼˜åŒ–å»ºè®®"><span>2. è¿è¡Œæ—¶ä¼˜åŒ–å»ºè®®</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// 1. ä½¿ç”¨å¿«é€Ÿè·¯å¾„</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ä¼˜åŒ–æ›´æ–°</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// å…¨é‡æ›´æ–°</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. æ‰¹é‡æ›´æ–°</span></span>
<span class="line"><span class="token function">startBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// å¤šä¸ªçŠ¶æ€æ›´æ–°</span></span>
<span class="line"><span class="token function">endBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 3. åˆç†ä½¿ç”¨ç¼“å­˜</span></span>
<span class="line"><span class="token keyword">const</span> computedValue <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">expensiveCalculation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 4. é¿å…ä¸å¿…è¦çš„å“åº”å¼</span></span>
<span class="line"><span class="token keyword">const</span> staticData <span class="token operator">=</span> <span class="token function">markRaw</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">static</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-å†…å­˜ä¼˜åŒ–å»ºè®®" tabindex="-1"><a class="header-anchor" href="#_3-å†…å­˜ä¼˜åŒ–å»ºè®®"><span>3. å†…å­˜ä¼˜åŒ–å»ºè®®</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// 1. ä½¿ç”¨WeakMap</span></span>
<span class="line"><span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. åŠæ—¶æ¸…ç†å¼•ç”¨</span></span>
<span class="line"><span class="token function">onUnmounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// æ¸…ç†å¼•ç”¨</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 3. é¿å…é—­åŒ…é™·é˜±</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ä½¿ç”¨data</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 4. ä½¿ç”¨shallowRef</span></span>
<span class="line"><span class="token keyword">const</span> largeData <span class="token operator">=</span> <span class="token function">shallowRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">/* å¤§é‡æ•°æ® */</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ¯-æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-æ€»ç»“"><span>ğŸ¯ æ€»ç»“</span></a></h2><p>Vue3çš„æ€§èƒ½ä¼˜åŒ–å±•ç°äº†ç°ä»£å‰ç«¯æ¡†æ¶çš„è®¾è®¡ç²¾é«“ï¼š</p><ol><li><strong>ç¼–è¯‘æ—¶ä¼˜åŒ–</strong> - é™æ€æå‡ã€è¡¥ä¸æ ‡å¿—ã€å—çº§ä¼˜åŒ–</li><li><strong>è¿è¡Œæ—¶ä¼˜åŒ–</strong> - å¿«é€Ÿè·¯å¾„ã€æ‰¹é‡æ›´æ–°ã€ç¼“å­˜æœºåˆ¶</li><li><strong>å†…å­˜ä¼˜åŒ–</strong> - WeakMapã€è‡ªåŠ¨GCã€ä¾èµ–æ¸…ç†</li><li><strong>æ€§èƒ½ç›‘æ§</strong> - æŒ‡æ ‡æ”¶é›†ã€æ€§èƒ½åˆ†æã€ä¼˜åŒ–å»ºè®®</li><li><strong>æœ€ä½³å®è·µ</strong> - ä¼˜åŒ–å»ºè®®ã€æ€§èƒ½æŒ‡å—ã€æœ€ä½³å®è·µ</li></ol><p>è¿™å¥—æ€§èƒ½ä¼˜åŒ–ä½“ç³»ä¸ä»…ä¸ºVue3æä¾›äº†å“è¶Šçš„æ€§èƒ½è¡¨ç°ï¼Œä¹Ÿä¸ºå…¶ä»–å‰ç«¯é¡¹ç›®æä¾›äº†ä¼˜ç§€çš„è®¾è®¡å‚è€ƒã€‚</p>`,42)]))}const i=s(t,[["render",l]]),u=JSON.parse('{"path":"/06-performance-optimization.html","title":"Vue3æ€§èƒ½ä¼˜åŒ–è¯¦è§£","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"ğŸ¯ æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°","slug":"ğŸ¯-æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°","link":"#ğŸ¯-æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°","children":[{"level":3,"title":"ä¼˜åŒ–æ¶æ„å›¾","slug":"ä¼˜åŒ–æ¶æ„å›¾","link":"#ä¼˜åŒ–æ¶æ„å›¾","children":[]}]},{"level":2,"title":"ğŸ”§ ç¼–è¯‘æ—¶ä¼˜åŒ–","slug":"ğŸ”§-ç¼–è¯‘æ—¶ä¼˜åŒ–","link":"#ğŸ”§-ç¼–è¯‘æ—¶ä¼˜åŒ–","children":[{"level":3,"title":"1. é™æ€æå‡ (Static Hoisting)","slug":"_1-é™æ€æå‡-static-hoisting","link":"#_1-é™æ€æå‡-static-hoisting","children":[]},{"level":3,"title":"2. è¡¥ä¸æ ‡å¿— (Patch Flags)","slug":"_2-è¡¥ä¸æ ‡å¿—-patch-flags","link":"#_2-è¡¥ä¸æ ‡å¿—-patch-flags","children":[]},{"level":3,"title":"3. å—çº§ä¼˜åŒ– (Block Optimization)","slug":"_3-å—çº§ä¼˜åŒ–-block-optimization","link":"#_3-å—çº§ä¼˜åŒ–-block-optimization","children":[]}]},{"level":2,"title":"âš¡ è¿è¡Œæ—¶ä¼˜åŒ–","slug":"âš¡-è¿è¡Œæ—¶ä¼˜åŒ–","link":"#âš¡-è¿è¡Œæ—¶ä¼˜åŒ–","children":[{"level":3,"title":"1. å¿«é€Ÿè·¯å¾„ (Fast Path)","slug":"_1-å¿«é€Ÿè·¯å¾„-fast-path","link":"#_1-å¿«é€Ÿè·¯å¾„-fast-path","children":[]},{"level":3,"title":"2. æ‰¹é‡æ›´æ–° (Batch Updates)","slug":"_2-æ‰¹é‡æ›´æ–°-batch-updates","link":"#_2-æ‰¹é‡æ›´æ–°-batch-updates","children":[]},{"level":3,"title":"3. ç¼“å­˜æœºåˆ¶ (Caching)","slug":"_3-ç¼“å­˜æœºåˆ¶-caching","link":"#_3-ç¼“å­˜æœºåˆ¶-caching","children":[]}]},{"level":2,"title":"ğŸ’¾ å†…å­˜ä¼˜åŒ–","slug":"ğŸ’¾-å†…å­˜ä¼˜åŒ–","link":"#ğŸ’¾-å†…å­˜ä¼˜åŒ–","children":[{"level":3,"title":"1. WeakMapé¿å…å†…å­˜æ³„æ¼","slug":"_1-weakmapé¿å…å†…å­˜æ³„æ¼","link":"#_1-weakmapé¿å…å†…å­˜æ³„æ¼","children":[]},{"level":3,"title":"2. åŒå‘é“¾è¡¨O(1)æ“ä½œ","slug":"_2-åŒå‘é“¾è¡¨o-1-æ“ä½œ","link":"#_2-åŒå‘é“¾è¡¨o-1-æ“ä½œ","children":[]},{"level":3,"title":"3. ä¾èµ–æ¸…ç†æœºåˆ¶","slug":"_3-ä¾èµ–æ¸…ç†æœºåˆ¶","link":"#_3-ä¾èµ–æ¸…ç†æœºåˆ¶","children":[]}]},{"level":2,"title":"ğŸ“Š æ€§èƒ½ç›‘æ§","slug":"ğŸ“Š-æ€§èƒ½ç›‘æ§","link":"#ğŸ“Š-æ€§èƒ½ç›‘æ§","children":[{"level":3,"title":"1. æ€§èƒ½æŒ‡æ ‡","slug":"_1-æ€§èƒ½æŒ‡æ ‡","link":"#_1-æ€§èƒ½æŒ‡æ ‡","children":[]},{"level":3,"title":"2. æ€§èƒ½åˆ†æ","slug":"_2-æ€§èƒ½åˆ†æ","link":"#_2-æ€§èƒ½åˆ†æ","children":[]}]},{"level":2,"title":"ğŸ¯ ä¼˜åŒ–å»ºè®®","slug":"ğŸ¯-ä¼˜åŒ–å»ºè®®","link":"#ğŸ¯-ä¼˜åŒ–å»ºè®®","children":[{"level":3,"title":"1. ç¼–è¯‘æ—¶ä¼˜åŒ–å»ºè®®","slug":"_1-ç¼–è¯‘æ—¶ä¼˜åŒ–å»ºè®®","link":"#_1-ç¼–è¯‘æ—¶ä¼˜åŒ–å»ºè®®","children":[]},{"level":3,"title":"2. è¿è¡Œæ—¶ä¼˜åŒ–å»ºè®®","slug":"_2-è¿è¡Œæ—¶ä¼˜åŒ–å»ºè®®","link":"#_2-è¿è¡Œæ—¶ä¼˜åŒ–å»ºè®®","children":[]},{"level":3,"title":"3. å†…å­˜ä¼˜åŒ–å»ºè®®","slug":"_3-å†…å­˜ä¼˜åŒ–å»ºè®®","link":"#_3-å†…å­˜ä¼˜åŒ–å»ºè®®","children":[]}]},{"level":2,"title":"ğŸ¯ æ€»ç»“","slug":"ğŸ¯-æ€»ç»“","link":"#ğŸ¯-æ€»ç»“","children":[]}],"git":{"updatedTime":1754567332000,"contributors":[{"name":"atian","username":"atian","email":"atian@micous.com","commits":1,"url":"https://github.com/atian"}],"changelog":[{"hash":"fc80bf956ce2f65021db3835863d30f81c328ee4","time":1754567332000,"email":"atian@micous.com","author":"atian","message":"æ›´æ–°GitHub Actionsæ–‡æ¡£ï¼Œæ·»åŠ ä»£ç å—æ ¼å¼åŒ–ï¼Œè¡¥å……ç›¸å…³é“¾æ¥ï¼Œå¹¶åœ¨VuePressé…ç½®ä¸­æ–°å¢Vue3æ ¸å¿ƒçŸ¥è¯†çš„å¯¼èˆªå’Œä¾§è¾¹æ ï¼Œä¼˜åŒ–é¡µé¢è·¯ç”±è®¾ç½®ã€‚"}]},"filePathRelative":"06-performance-optimization.md"}');export{i as comp,u as data};

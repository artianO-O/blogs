<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Vue3è™šæ‹ŸDOMç³»ç»Ÿè¯¦è§£ | æˆ‘çš„ä¸»é¡µ</title><meta name="description" content="æˆ‘çš„ä¸ªäººåšå®¢å’ŒæŠ€æœ¯åˆ†äº«ç«™ç‚¹">
    <link rel="preload" href="/blogs/assets/style-B3-VMakp.css" as="style"><link rel="stylesheet" href="/blogs/assets/style-B3-VMakp.css">
    <link rel="modulepreload" href="/blogs/assets/app-BYt8acor.js"><link rel="modulepreload" href="/blogs/assets/03-virtual-dom-system.html-DqQJ0CRB.js">
    <link rel="prefetch" href="/blogs/assets/01-architecture-design.html-KL7cQ4lz.js" as="script"><link rel="prefetch" href="/blogs/assets/02-reactivity-system.html-BQuSKDxH.js" as="script"><link rel="prefetch" href="/blogs/assets/04-compiler-system.html-D3QYnoLx.js" as="script"><link rel="prefetch" href="/blogs/assets/05-component-system.html-CoGC-G7J.js" as="script"><link rel="prefetch" href="/blogs/assets/06-performance-optimization.html-DrDU8gtU.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-D5hugcbD.js" as="script"><link rel="prefetch" href="/blogs/assets/cursorRule.html-DY-9-KhI.js" as="script"><link rel="prefetch" href="/blogs/assets/get-started.html-qNqkNiEA.js" as="script"><link rel="prefetch" href="/blogs/assets/githubAction.html-DJ3MjNT2.js" as="script"><link rel="prefetch" href="/blogs/assets/vue3-core.html-D-6m078R.js" as="script"><link rel="prefetch" href="/blogs/assets/å°ç¨‹åºå¼€å‘.html-BKfwb0_q.js" as="script"><link rel="prefetch" href="/blogs/assets/æ‰“åŒ…å·¥å…·viteä¸webpack.html-D0vBZriz.js" as="script"><link rel="prefetch" href="/blogs/assets/AIå¤§æ¨¡å‹æ•´ç†.html-Db-1ILhE.js" as="script"><link rel="prefetch" href="/blogs/assets/AIèµšé’±æ€è·¯.html-B6jdUuqZ.js" as="script"><link rel="prefetch" href="/blogs/assets/404.html-DQcMc8oj.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/blogs/"><img class="vp-site-logo" src="https://vuejs.press/images/hero.png" alt="æˆ‘çš„ä¸»é¡µ"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">æˆ‘çš„ä¸»é¡µ</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/get-started.html" aria-label="ä¸»é¡µ"><!--[--><!--[--><!--]--><!--]-->ä¸»é¡µ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/githubAction.html" aria-label="æ•™ç¨‹"><!--[--><!--[--><!--]--><!--]-->æ•™ç¨‹<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/vue3-core.html" aria-label="Vue3æºç è§£æ"><!--[--><!--[--><!--]--><!--]-->Vue3æºç è§£æ<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/get-started.html" aria-label="ä¸»é¡µ"><!--[--><!--[--><!--]--><!--]-->ä¸»é¡µ<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/githubAction.html" aria-label="æ•™ç¨‹"><!--[--><!--[--><!--]--><!--]-->æ•™ç¨‹<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/vue3-core.html" aria-label="Vue3æºç è§£æ"><!--[--><!--[--><!--]--><!--]-->Vue3æºç è§£æ<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active collapsible">Vue3æ ¸å¿ƒçŸ¥è¯† <span class="down arrow"></span></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/blogs/vue3-core.html" aria-label="Vue3æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»è§ˆ"><!--[--><!--[--><!--]--><!--]-->Vue3æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»è§ˆ<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/blogs/01-architecture-design.html" aria-label="Vue3æ¶æ„è®¾è®¡è¯¦è§£"><!--[--><!--[--><!--]--><!--]-->Vue3æ¶æ„è®¾è®¡è¯¦è§£<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/blogs/02-reactivity-system.html" aria-label="Vue3å“åº”å¼ç³»ç»Ÿè¯¦è§£"><!--[--><!--[--><!--]--><!--]-->Vue3å“åº”å¼ç³»ç»Ÿè¯¦è§£<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/blogs/03-virtual-dom-system.html" aria-label="Vue3è™šæ‹ŸDOMç³»ç»Ÿè¯¦è§£"><!--[--><!--[--><!--]--><!--]-->Vue3è™šæ‹ŸDOMç³»ç»Ÿè¯¦è§£<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/blogs/04-compiler-system.html" aria-label="Vue3ç¼–è¯‘å™¨ç³»ç»Ÿè¯¦è§£"><!--[--><!--[--><!--]--><!--]-->Vue3ç¼–è¯‘å™¨ç³»ç»Ÿè¯¦è§£<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/blogs/05-component-system.html" aria-label="Vue3ç»„ä»¶ç³»ç»Ÿè¯¦è§£"><!--[--><!--[--><!--]--><!--]-->Vue3ç»„ä»¶ç³»ç»Ÿè¯¦è§£<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/blogs/06-performance-optimization.html" aria-label="Vue3æ€§èƒ½ä¼˜åŒ–è¯¦è§£"><!--[--><!--[--><!--]--><!--]-->Vue3æ€§èƒ½ä¼˜åŒ–è¯¦è§£<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="vue3è™šæ‹Ÿdomç³»ç»Ÿè¯¦è§£" tabindex="-1"><a class="header-anchor" href="#vue3è™šæ‹Ÿdomç³»ç»Ÿè¯¦è§£"><span>Vue3è™šæ‹ŸDOMç³»ç»Ÿè¯¦è§£</span></a></h1><h2 id="ğŸ¯-è™šæ‹Ÿdomæ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-è™šæ‹Ÿdomæ¦‚è¿°"><span>ğŸ¯ è™šæ‹ŸDOMæ¦‚è¿°</span></a></h2><p>Vue3çš„è™šæ‹ŸDOMç³»ç»Ÿæ˜¯æ¡†æ¶çš„æ ¸å¿ƒæ¸²æŸ“æœºåˆ¶ï¼Œå®ƒé€šè¿‡JavaScriptå¯¹è±¡æ¥æè¿°çœŸå®çš„DOMç»“æ„ï¼Œå®ç°äº†é«˜æ•ˆçš„DOMæ›´æ–°å’Œè·¨å¹³å°æ¸²æŸ“ã€‚</p><h3 id="ç³»ç»Ÿæ¶æ„å›¾" tabindex="-1"><a class="header-anchor" href="#ç³»ç»Ÿæ¶æ„å›¾"><span>ç³»ç»Ÿæ¶æ„å›¾</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚        è™šæ‹ŸDOMå±‚ (VNode Layer)      â”‚</span>
<span class="line">â”‚  createVNode() | h() | render()    â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚        æ¸²æŸ“å™¨å±‚ (Renderer Layer)    â”‚</span>
<span class="line">â”‚  patch() | mount() | unmount()     â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚        å¹³å°å±‚ (Platform Layer)      â”‚</span>
<span class="line">â”‚  DOMæ“ä½œ | Canvas | å°ç¨‹åºç­‰        â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ—ï¸-vnodeè®¾è®¡" tabindex="-1"><a class="header-anchor" href="#ğŸ—ï¸-vnodeè®¾è®¡"><span>ğŸ—ï¸ VNodeè®¾è®¡</span></a></h2><h3 id="_1-vnodeæ¥å£å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#_1-vnodeæ¥å£å®šä¹‰"><span>1. VNodeæ¥å£å®šä¹‰</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNode<span class="token operator">&lt;</span></span>
<span class="line">  HostNode <span class="token operator">=</span> RendererNode<span class="token punctuation">,</span></span>
<span class="line">  HostElement <span class="token operator">=</span> RendererElement<span class="token punctuation">,</span></span>
<span class="line">  ExtraProps <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">  __v_isVNode<span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">SKIP</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// åŸºç¡€å±æ€§</span></span>
<span class="line">  type<span class="token operator">:</span> VNodeTypes</span>
<span class="line">  props<span class="token operator">:</span> <span class="token punctuation">(</span>VNodeProps <span class="token operator">&amp;</span> ExtraProps<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line">  key<span class="token operator">:</span> PropertyKey <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line">  ref<span class="token operator">:</span> VNodeNormalizedRef <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// å­èŠ‚ç‚¹</span></span>
<span class="line">  children<span class="token operator">:</span> VNodeNormalizedChildren</span>
<span class="line"></span>
<span class="line">  <span class="token comment">// ç»„ä»¶ç›¸å…³</span></span>
<span class="line">  component<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line">  dirs<span class="token operator">:</span> DirectiveBinding<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line">  transition<span class="token operator">:</span> TransitionHooks<span class="token operator">&lt;</span>HostElement<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// DOMç›¸å…³</span></span>
<span class="line">  el<span class="token operator">:</span> HostNode <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line">  anchor<span class="token operator">:</span> HostNode <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line">  target<span class="token operator">:</span> HostElement <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// ä¼˜åŒ–ç›¸å…³</span></span>
<span class="line">  shapeFlag<span class="token operator">:</span> <span class="token builtin">number</span></span>
<span class="line">  patchFlag<span class="token operator">:</span> <span class="token builtin">number</span></span>
<span class="line">  dynamicProps<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line">  dynamicChildren<span class="token operator">:</span> <span class="token punctuation">(</span>VNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span> hasOnce<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// åº”ç”¨ç›¸å…³</span></span>
<span class="line">  appContext<span class="token operator">:</span> AppContext <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line">  ctx<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-vnodeç±»å‹ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#_2-vnodeç±»å‹ç³»ç»Ÿ"><span>2. VNodeç±»å‹ç³»ç»Ÿ</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">VNodeTypes</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token operator">|</span> <span class="token builtin">string</span> <span class="token comment">// å…ƒç´ ç±»å‹</span></span>
<span class="line">  <span class="token operator">|</span> VNode <span class="token comment">// è™šæ‹ŸèŠ‚ç‚¹</span></span>
<span class="line">  <span class="token operator">|</span> Component <span class="token comment">// ç»„ä»¶</span></span>
<span class="line">  <span class="token operator">|</span> <span class="token keyword">typeof</span> Text <span class="token comment">// æ–‡æœ¬èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token operator">|</span> <span class="token keyword">typeof</span> Static <span class="token comment">// é™æ€èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token operator">|</span> <span class="token keyword">typeof</span> Comment <span class="token comment">// æ³¨é‡ŠèŠ‚ç‚¹</span></span>
<span class="line">  <span class="token operator">|</span> <span class="token keyword">typeof</span> Fragment <span class="token comment">// ç‰‡æ®µ</span></span>
<span class="line">  <span class="token operator">|</span> <span class="token keyword">typeof</span> Teleport <span class="token comment">// ä¼ é€é—¨</span></span>
<span class="line">  <span class="token operator">|</span> <span class="token keyword">typeof</span> TeleportImpl <span class="token comment">// ä¼ é€é—¨å®ç°</span></span>
<span class="line">  <span class="token operator">|</span> <span class="token keyword">typeof</span> Suspense <span class="token comment">// å¼‚æ­¥ç»„ä»¶</span></span>
<span class="line">  <span class="token operator">|</span> <span class="token keyword">typeof</span> SuspenseImpl <span class="token comment">// å¼‚æ­¥ç»„ä»¶å®ç°</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> Fragment <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&#39;v-fgt&#39;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">any</span> <span class="token keyword">as</span> <span class="token punctuation">{</span></span>
<span class="line">  __isFragment<span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span> $props<span class="token operator">:</span> VNodeProps <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> Text<span class="token operator">:</span> unique <span class="token builtin">symbol</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&#39;v-txt&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> Comment<span class="token operator">:</span> unique <span class="token builtin">symbol</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&#39;v-cmt&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> Static<span class="token operator">:</span> unique <span class="token builtin">symbol</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&#39;v-stc&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-vnodeåˆ›å»ºå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_3-vnodeåˆ›å»ºå‡½æ•°"><span>3. VNodeåˆ›å»ºå‡½æ•°</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// åˆ›å»ºVNodeçš„æ ¸å¿ƒå‡½æ•°</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createVNode</span><span class="token punctuation">(</span></span>
<span class="line">  type<span class="token operator">:</span> VNodeTypes <span class="token operator">|</span> ClassComponent <span class="token operator">|</span> <span class="token keyword">typeof</span> <span class="token constant">NULL_DYNAMIC_COMPONENT</span><span class="token punctuation">,</span></span>
<span class="line">  props<span class="token operator">:</span> <span class="token punctuation">(</span>Data <span class="token operator">&amp;</span> VNodeProps<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  children<span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  patchFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">  dynamicProps<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  isBlockNode <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// å¤„ç†ç±»å‹</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> cloned <span class="token operator">=</span> <span class="token function">cloneVNode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>cloned<span class="token punctuation">,</span> children<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> cloned</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// å¤„ç†ç±»ç»„ä»¶</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isClassComponent</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    type <span class="token operator">=</span> type<span class="token punctuation">.</span>__vccOpts</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// è§„èŒƒåŒ–props</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    props <span class="token operator">=</span> <span class="token function">guardReactiveProps</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token operator">!</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// åˆ›å»ºVNode</span></span>
<span class="line">  <span class="token keyword">const</span> vnode<span class="token operator">:</span> VNode <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    __v_isVNode<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">SKIP</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    type<span class="token punctuation">,</span></span>
<span class="line">    props<span class="token punctuation">,</span></span>
<span class="line">    key<span class="token operator">:</span> props <span class="token operator">&amp;&amp;</span> <span class="token function">normalizeKey</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    ref<span class="token operator">:</span> props <span class="token operator">&amp;&amp;</span> <span class="token function">normalizeRef</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    scopeId<span class="token operator">:</span> currentScopeId<span class="token punctuation">,</span></span>
<span class="line">    slotScopeIds<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    children<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    component<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    dirs<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    transition<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    el<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    anchor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    target<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    targetAnchor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    staticCount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    suspense<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    ssContent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    ssFallback<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    shapeFlag<span class="token operator">:</span> type <span class="token operator">===</span> Fragment <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span></span>
<span class="line">    patchFlag<span class="token punctuation">,</span></span>
<span class="line">    dynamicProps<span class="token punctuation">,</span></span>
<span class="line">    dynamicChildren<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    appContext<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    ctx<span class="token operator">:</span> currentRenderingInstance<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// è§„èŒƒåŒ–å­èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> children<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// å¤„ç†å—çº§èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>isBlockNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">setupBlock</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> vnode</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ›ï¸-å½¢çŠ¶æ ‡å¿—-shapeflags" tabindex="-1"><a class="header-anchor" href="#ğŸ›ï¸-å½¢çŠ¶æ ‡å¿—-shapeflags"><span>ğŸ›ï¸ å½¢çŠ¶æ ‡å¿— (ShapeFlags)</span></a></h2><h3 id="_1-å½¢çŠ¶æ ‡å¿—å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#_1-å½¢çŠ¶æ ‡å¿—å®šä¹‰"><span>1. å½¢çŠ¶æ ‡å¿—å®šä¹‰</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">enum</span> ShapeFlags <span class="token punctuation">{</span></span>
<span class="line">  <span class="token constant">ELEMENT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// å…ƒç´ èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">FUNCTIONAL_COMPONENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// å‡½æ•°å¼ç»„ä»¶</span></span>
<span class="line">  <span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// æœ‰çŠ¶æ€ç»„ä»¶</span></span>
<span class="line">  <span class="token constant">TEXT_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// æ–‡æœ¬å­èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">ARRAY_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// æ•°ç»„å­èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">SLOTS_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// æ’æ§½å­èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token constant">TELEPORT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token comment">// ä¼ é€é—¨</span></span>
<span class="line">  <span class="token constant">SUSPENSE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token comment">// å¼‚æ­¥ç»„ä»¶</span></span>
<span class="line">  <span class="token constant">COMPONENT_SHOULD_KEEP_ALIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// åº”è¯¥ä¿æŒæ´»è·ƒçš„ç»„ä»¶</span></span>
<span class="line">  <span class="token constant">COMPONENT_KEPT_ALIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token comment">// ä¿æŒæ´»è·ƒçš„ç»„ä»¶</span></span>
<span class="line">  <span class="token constant">COMPONENT</span> <span class="token operator">=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">|</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">FUNCTIONAL_COMPONENT</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-å½¢çŠ¶æ ‡å¿—ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_2-å½¢çŠ¶æ ‡å¿—ä½¿ç”¨"><span>2. å½¢çŠ¶æ ‡å¿—ä½¿ç”¨</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// è®¾ç½®å½¢çŠ¶æ ‡å¿—</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">setShapeFlag</span><span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> flag<span class="token operator">:</span> ShapeFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">|=</span> flag</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ£€æŸ¥å½¢çŠ¶æ ‡å¿—</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">hasShapeFlag</span><span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> flag<span class="token operator">:</span> ShapeFlags<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">&amp;</span> flag<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç¤ºä¾‹ï¼šåˆ›å»ºå…ƒç´ èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&#39;container&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;Hello Vue3&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token function">setShapeFlag</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span> <span class="token operator">|</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// vnode.shapeFlag = 9 (1 + 8)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ¯-è¡¥ä¸æ ‡å¿—-patchflags" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-è¡¥ä¸æ ‡å¿—-patchflags"><span>ğŸ¯ è¡¥ä¸æ ‡å¿— (PatchFlags)</span></a></h2><h3 id="_1-è¡¥ä¸æ ‡å¿—å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#_1-è¡¥ä¸æ ‡å¿—å®šä¹‰"><span>1. è¡¥ä¸æ ‡å¿—å®šä¹‰</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> PatchFlags <span class="token punctuation">{</span></span>
<span class="line">  <span class="token constant">TEXT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€æ–‡æœ¬å†…å®¹</span></span>
<span class="line">  <span class="token constant">CLASS</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€ç±»å</span></span>
<span class="line">  <span class="token constant">STYLE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€æ ·å¼</span></span>
<span class="line">  <span class="token constant">PROPS</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€å±æ€§</span></span>
<span class="line">  <span class="token constant">FULL_PROPS</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// å…¨é‡å±æ€§æ›´æ–°</span></span>
<span class="line">  <span class="token constant">HYDRATE_EVENTS</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// æ°´åˆäº‹ä»¶</span></span>
<span class="line">  <span class="token constant">STABLE_FRAGMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token comment">// ç¨³å®šç‰‡æ®µ</span></span>
<span class="line">  <span class="token constant">KEYED_FRAGMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token comment">// å¸¦é”®çš„ç‰‡æ®µ</span></span>
<span class="line">  <span class="token constant">UNKEYED_FRAGMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// æ— é”®çš„ç‰‡æ®µ</span></span>
<span class="line">  <span class="token constant">NEED_PATCH</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token comment">// éœ€è¦è¡¥ä¸</span></span>
<span class="line">  <span class="token constant">DYNAMIC_SLOTS</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€æ’æ§½</span></span>
<span class="line">  <span class="token constant">HOISTED</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// é™æ€æå‡</span></span>
<span class="line">  <span class="token constant">BAIL</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// è·³è¿‡ä¼˜åŒ–</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-è¡¥ä¸æ ‡å¿—ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_2-è¡¥ä¸æ ‡å¿—ä¼˜åŒ–"><span>2. è¡¥ä¸æ ‡å¿—ä¼˜åŒ–</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// ç¼–è¯‘æ—¶ç”Ÿæˆçš„ä¼˜åŒ–ä»£ç </span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token function">openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">createElementBlock</span><span class="token punctuation">(</span></span>
<span class="line">      <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">class</span><span class="token operator">:</span> _ctx<span class="token punctuation">.</span>dynamicClass<span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€ç±»å</span></span>
<span class="line">        style<span class="token operator">:</span> _ctx<span class="token punctuation">.</span>dynamicStyle<span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€æ ·å¼</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">[</span></span>
<span class="line">        <span class="token function">createTextVNode</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// åŠ¨æ€æ–‡æœ¬</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">6</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span> <span class="token comment">// patchFlag = 6 (CLASS + STYLE)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¿è¡Œæ—¶æ ¹æ®patchFlagè¿›è¡Œä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">patchElement</span><span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode<span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> patchFlag <span class="token punctuation">}</span> <span class="token operator">=</span> n2</span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æœ‰è¡¥ä¸æ ‡å¿—ï¼Œè¿›è¡Œä¼˜åŒ–æ›´æ–°</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">CLASS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// åªæ›´æ–°ç±»å</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>n1<span class="token punctuation">.</span>props<span class="token punctuation">.</span>class <span class="token operator">!==</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>class<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">hostPatchProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">&#39;class&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>class<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">STYLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// åªæ›´æ–°æ ·å¼</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>n1<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style <span class="token operator">!==</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">hostPatchProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">,</span> n1<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>style<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// åªæ›´æ–°æ–‡æœ¬å†…å®¹</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>n1<span class="token punctuation">.</span>children <span class="token operator">!==</span> n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">hostSetElementText</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ— è¡¥ä¸æ ‡å¿—ï¼Œå…¨é‡æ›´æ–°</span></span>
<span class="line">    <span class="token function">patchProps</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> n1<span class="token punctuation">.</span>props<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”§-å—çº§ä¼˜åŒ–-block-optimization" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-å—çº§ä¼˜åŒ–-block-optimization"><span>ğŸ”§ å—çº§ä¼˜åŒ– (Block Optimization)</span></a></h2><h3 id="_1-å—çº§èŠ‚ç‚¹æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#_1-å—çº§èŠ‚ç‚¹æ¦‚å¿µ"><span>1. å—çº§èŠ‚ç‚¹æ¦‚å¿µ</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// å—çº§èŠ‚ç‚¹ï¼šåŒ…å«åŠ¨æ€å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">let</span> currentBlock<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"><span class="token keyword">let</span> currentBlockTree<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¼€å¯å—çº§è¿½è¸ª</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">openBlock</span><span class="token punctuation">(</span>disableTracking <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disableTracking<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    currentBlock <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å…³é—­å—çº§è¿½è¸ª</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">closeBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span></span>
<span class="line">  currentBlock <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è®¾ç½®å—çº§èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">setupBlock</span><span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    vnode<span class="token punctuation">.</span>dynamicChildren <span class="token operator">=</span> currentBlock</span>
<span class="line">    currentBlock <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-å—çº§ä¼˜åŒ–ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_2-å—çº§ä¼˜åŒ–ç¤ºä¾‹"><span>2. å—çº§ä¼˜åŒ–ç¤ºä¾‹</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// æ¨¡æ¿</span></span>
<span class="line"><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> message <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> count <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>é™æ€æ–‡æœ¬<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç¼–è¯‘ç»“æœ</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">createElementBlock</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token function">createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// TEXT</span></span>
<span class="line">    <span class="token function">createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// TEXT</span></span>
<span class="line">    <span class="token function">createElementVNode</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;é™æ€æ–‡æœ¬&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// é™æ€èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¿è¡Œæ—¶ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">patchBlockChildren</span><span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode<span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> dynamicChildren <span class="token punctuation">}</span> <span class="token operator">=</span> n2</span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamicChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åªæ›´æ–°åŠ¨æ€å­èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dynamicChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> dynamicChild <span class="token operator">=</span> dynamicChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">      <span class="token keyword">const</span> child <span class="token operator">=</span> n1<span class="token punctuation">.</span>dynamicChildren<span class="token operator">!</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">      <span class="token function">patch</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> dynamicChild<span class="token punctuation">,</span> container<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å…¨é‡æ›´æ–°</span></span>
<span class="line">    <span class="token function">patchChildren</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ¨-é™æ€æå‡-static-hoisting" tabindex="-1"><a class="header-anchor" href="#ğŸ¨-é™æ€æå‡-static-hoisting"><span>ğŸ¨ é™æ€æå‡ (Static Hoisting)</span></a></h2><h3 id="_1-é™æ€æå‡æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_1-é™æ€æå‡æœºåˆ¶"><span>1. é™æ€æå‡æœºåˆ¶</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// é™æ€èŠ‚ç‚¹æå‡</span></span>
<span class="line"><span class="token keyword">const</span> hoisted <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createVNode</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&#39;static-class&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    id<span class="token operator">:</span> <span class="token string">&#39;static-id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">[</span><span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&#39;é™æ€å†…å®¹&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç¼–è¯‘ç»“æœ</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token function">openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">createElementBlock</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span></span>
<span class="line">      hoisted<span class="token punctuation">,</span> <span class="token comment">// å¤ç”¨é™æ€èŠ‚ç‚¹</span></span>
<span class="line">      <span class="token function">createElementVNode</span><span class="token punctuation">(</span><span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-é™æ€æå‡ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_2-é™æ€æå‡ä¼˜åŒ–"><span>2. é™æ€æå‡ä¼˜åŒ–</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// é™æ€èŠ‚ç‚¹ç¼“å­˜</span></span>
<span class="line"><span class="token keyword">const</span> staticVNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ£€æŸ¥æ˜¯å¦ä¸ºé™æ€èŠ‚ç‚¹</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">isStaticVNode</span><span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    vnode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;div&#39;</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">    vnode<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span></span>
<span class="line">    vnode<span class="token punctuation">.</span>props<span class="token punctuation">.</span>class <span class="token operator">===</span> <span class="token string">&#39;static-class&#39;</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">    <span class="token operator">!</span>vnode<span class="token punctuation">.</span>dynamicChildren</span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// é™æ€èŠ‚ç‚¹å¤ç”¨</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">cloneIfMounted</span><span class="token punctuation">(</span>child<span class="token operator">:</span> VNode<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> el <span class="token operator">=</span> child<span class="token punctuation">.</span>el</span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// å·²æŒ‚è½½çš„é™æ€èŠ‚ç‚¹ï¼Œåˆ›å»ºæ–°çš„VNode</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token function">cloneVNode</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> child</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”„-diffç®—æ³•" tabindex="-1"><a class="header-anchor" href="#ğŸ”„-diffç®—æ³•"><span>ğŸ”„ Diffç®—æ³•</span></a></h2><h3 id="_1-å¿«é€Ÿdiffç®—æ³•" tabindex="-1"><a class="header-anchor" href="#_1-å¿«é€Ÿdiffç®—æ³•"><span>1. å¿«é€ŸDiffç®—æ³•</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span></span>
<span class="line">  c1<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  c2<span class="token operator">:</span> VNodeArrayChildren<span class="token punctuation">,</span></span>
<span class="line">  container<span class="token operator">:</span> RendererElement<span class="token punctuation">,</span></span>
<span class="line">  parentAnchor<span class="token operator">:</span> RendererNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  parentComponent<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  parentSuspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  namespace<span class="token operator">:</span> ElementNamespace<span class="token punctuation">,</span></span>
<span class="line">  slotScopeIds<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  optimized<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">  <span class="token keyword">const</span> l2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length</span>
<span class="line">  <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span></span>
<span class="line">  <span class="token keyword">let</span> e2 <span class="token operator">=</span> l2 <span class="token operator">-</span> <span class="token number">1</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 1. ä»å¤´éƒ¨å¼€å§‹æ¯”è¾ƒ</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">const</span> n2 <span class="token operator">=</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode</span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">patch</span><span class="token punctuation">(</span></span>
<span class="line">        n1<span class="token punctuation">,</span></span>
<span class="line">        n2<span class="token punctuation">,</span></span>
<span class="line">        container<span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">        parentComponent<span class="token punctuation">,</span></span>
<span class="line">        parentSuspense<span class="token punctuation">,</span></span>
<span class="line">        namespace<span class="token punctuation">,</span></span>
<span class="line">        slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">        optimized<span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    i<span class="token operator">++</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 2. ä»å°¾éƒ¨å¼€å§‹æ¯”è¾ƒ</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">const</span> n2 <span class="token operator">=</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode</span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">patch</span><span class="token punctuation">(</span></span>
<span class="line">        n1<span class="token punctuation">,</span></span>
<span class="line">        n2<span class="token punctuation">,</span></span>
<span class="line">        container<span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">        parentComponent<span class="token punctuation">,</span></span>
<span class="line">        parentSuspense<span class="token punctuation">,</span></span>
<span class="line">        namespace<span class="token punctuation">,</span></span>
<span class="line">        slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">        optimized<span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">break</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    e1<span class="token operator">--</span></span>
<span class="line">    e2<span class="token operator">--</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 3. å¤„ç†æ–°å¢èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> nextPos <span class="token operator">=</span> e2 <span class="token operator">+</span> <span class="token number">1</span></span>
<span class="line">      <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextPos <span class="token operator">&lt;</span> l2 <span class="token operator">?</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span><span class="token punctuation">.</span>el <span class="token operator">:</span> parentAnchor</span>
<span class="line">      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">patch</span><span class="token punctuation">(</span></span>
<span class="line">          <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">          c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">,</span></span>
<span class="line">          container<span class="token punctuation">,</span></span>
<span class="line">          anchor<span class="token punctuation">,</span></span>
<span class="line">          parentComponent<span class="token punctuation">,</span></span>
<span class="line">          parentSuspense<span class="token punctuation">,</span></span>
<span class="line">          namespace<span class="token punctuation">,</span></span>
<span class="line">          slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">          optimized<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        i<span class="token operator">++</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 4. å¤„ç†åˆ é™¤èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">unmount</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">      i<span class="token operator">++</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 5. å¤„ç†æœªçŸ¥åºåˆ—</span></span>
<span class="line">  <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> s1 <span class="token operator">=</span> i</span>
<span class="line">    <span class="token keyword">const</span> s2 <span class="token operator">=</span> i</span>
<span class="line">    <span class="token keyword">const</span> keyToNewIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å»ºç«‹æ–°èŠ‚ç‚¹çš„keyæ˜ å°„</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s2<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> nextChild <span class="token operator">=</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode</span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// æ›´æ–°å’Œç§»åŠ¨èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token keyword">let</span> patched <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    <span class="token keyword">const</span> toBePatched <span class="token operator">=</span> e2 <span class="token operator">-</span> s2 <span class="token operator">+</span> <span class="token number">1</span></span>
<span class="line">    <span class="token keyword">let</span> moved <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token keyword">let</span> maxNewIndexSoFar <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> s1<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e1<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> prevChild <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>patched <span class="token operator">&gt;=</span> toBePatched<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">unmount</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">continue</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">let</span> newIndex</span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        newIndex <span class="token operator">=</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// æ— keyçš„èŠ‚ç‚¹ï¼Œéœ€è¦éå†æŸ¥æ‰¾</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> s2<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            newIndex <span class="token operator">=</span> j</span>
<span class="line">            <span class="token keyword">break</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">unmount</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">&gt;=</span> maxNewIndexSoFar<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          maxNewIndexSoFar <span class="token operator">=</span> newIndex</span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">          moved <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">patch</span><span class="token punctuation">(</span></span>
<span class="line">          prevChild<span class="token punctuation">,</span></span>
<span class="line">          c2<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">,</span></span>
<span class="line">          container<span class="token punctuation">,</span></span>
<span class="line">          <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">          parentComponent<span class="token punctuation">,</span></span>
<span class="line">          parentSuspense<span class="token punctuation">,</span></span>
<span class="line">          namespace<span class="token punctuation">,</span></span>
<span class="line">          slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">          optimized<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        patched<span class="token operator">++</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#_2-æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•"><span>2. æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">getSequence</span><span class="token punctuation">(</span>arr<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> p <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token keyword">let</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v<span class="token punctuation">,</span> c</span>
<span class="line">  <span class="token keyword">const</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length</span>
<span class="line"></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> arrI <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>arrI <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      j <span class="token operator">=</span> result<span class="token punctuation">[</span>result<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> arrI<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j</span>
<span class="line">        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">continue</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      u <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">      v <span class="token operator">=</span> result<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span></span>
<span class="line">      <span class="token keyword">while</span> <span class="token punctuation">(</span>u <span class="token operator">&lt;</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u <span class="token operator">+</span> v<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>result<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> arrI<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          u <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">          v <span class="token operator">=</span> c</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>arrI <span class="token operator">&lt;</span> arr<span class="token punctuation">[</span>result<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        result<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> i</span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  u <span class="token operator">=</span> result<span class="token punctuation">.</span>length</span>
<span class="line">  v <span class="token operator">=</span> result<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>u<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    result<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> v</span>
<span class="line">    v <span class="token operator">=</span> p<span class="token punctuation">[</span>v<span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> result</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ›ï¸-æ¸²æŸ“å™¨ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#ğŸ›ï¸-æ¸²æŸ“å™¨ç³»ç»Ÿ"><span>ğŸ›ï¸ æ¸²æŸ“å™¨ç³»ç»Ÿ</span></a></h2><h3 id="_1-æ¸²æŸ“å™¨æ¥å£" tabindex="-1"><a class="header-anchor" href="#_1-æ¸²æŸ“å™¨æ¥å£"><span>1. æ¸²æŸ“å™¨æ¥å£</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Renderer<span class="token operator">&lt;</span>HostElement <span class="token operator">=</span> RendererElement<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">  render<span class="token operator">:</span> RootRenderFunction<span class="token operator">&lt;</span>HostElement<span class="token operator">&gt;</span></span>
<span class="line">  createApp<span class="token operator">:</span> CreateAppFunction<span class="token operator">&lt;</span>HostElement<span class="token operator">&gt;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RendererOptions<span class="token operator">&lt;</span></span>
<span class="line">  HostNode <span class="token operator">=</span> RendererNode<span class="token punctuation">,</span></span>
<span class="line">  HostElement <span class="token operator">=</span> RendererElement<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">patchProp</span><span class="token punctuation">(</span></span>
<span class="line">    el<span class="token operator">:</span> HostElement<span class="token punctuation">,</span></span>
<span class="line">    key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">    prevValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span></span>
<span class="line">    nextValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span></span>
<span class="line">    namespace<span class="token operator">?</span><span class="token operator">:</span> ElementNamespace<span class="token punctuation">,</span></span>
<span class="line">    parentComponent<span class="token operator">?</span><span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">insert</span><span class="token punctuation">(</span>el<span class="token operator">:</span> HostNode<span class="token punctuation">,</span> parent<span class="token operator">:</span> HostElement<span class="token punctuation">,</span> anchor<span class="token operator">?</span><span class="token operator">:</span> HostNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">remove</span><span class="token punctuation">(</span>el<span class="token operator">:</span> HostNode<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">createElement</span><span class="token punctuation">(</span></span>
<span class="line">    type<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">    namespace<span class="token operator">?</span><span class="token operator">:</span> ElementNamespace<span class="token punctuation">,</span></span>
<span class="line">    isCustomizedBuiltIn<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token operator">:</span> HostElement</span>
<span class="line">  <span class="token function">createText</span><span class="token punctuation">(</span>text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> HostNode</span>
<span class="line">  <span class="token function">createComment</span><span class="token punctuation">(</span>text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> HostNode</span>
<span class="line">  <span class="token function">setText</span><span class="token punctuation">(</span>node<span class="token operator">:</span> HostNode<span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">setElementText</span><span class="token punctuation">(</span>node<span class="token operator">:</span> HostElement<span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span></span>
<span class="line">  <span class="token function">parentNode</span><span class="token punctuation">(</span>node<span class="token operator">:</span> HostNode<span class="token punctuation">)</span><span class="token operator">:</span> HostElement <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line">  <span class="token function">nextSibling</span><span class="token punctuation">(</span>node<span class="token operator">:</span> HostNode<span class="token punctuation">)</span><span class="token operator">:</span> HostNode <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-åˆ›å»ºæ¸²æŸ“å™¨" tabindex="-1"><a class="header-anchor" href="#_2-åˆ›å»ºæ¸²æŸ“å™¨"><span>2. åˆ›å»ºæ¸²æŸ“å™¨</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">createRenderer</span><span class="token generic class-name"><span class="token operator">&lt;</span>HostNode<span class="token punctuation">,</span> HostElement<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span></span>
<span class="line">  options<span class="token operator">:</span> RendererOptions<span class="token operator">&lt;</span>HostNode<span class="token punctuation">,</span> HostElement<span class="token operator">&gt;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> Renderer<span class="token operator">&lt;</span>HostElement<span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">baseCreateRenderer</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">baseCreateRenderer</span><span class="token punctuation">(</span></span>
<span class="line">  options<span class="token operator">:</span> RendererOptions<span class="token operator">&lt;</span>Node<span class="token punctuation">,</span> Element<span class="token operator">&gt;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> Renderer<span class="token operator">&lt;</span>Element<span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">    insert<span class="token operator">:</span> hostInsert<span class="token punctuation">,</span></span>
<span class="line">    remove<span class="token operator">:</span> hostRemove<span class="token punctuation">,</span></span>
<span class="line">    patchProp<span class="token operator">:</span> hostPatchProp<span class="token punctuation">,</span></span>
<span class="line">    createElement<span class="token operator">:</span> hostCreateElement<span class="token punctuation">,</span></span>
<span class="line">    createText<span class="token operator">:</span> hostCreateText<span class="token punctuation">,</span></span>
<span class="line">    createComment<span class="token operator">:</span> hostCreateComment<span class="token punctuation">,</span></span>
<span class="line">    setText<span class="token operator">:</span> hostSetText<span class="token punctuation">,</span></span>
<span class="line">    setElementText<span class="token operator">:</span> hostSetElementText<span class="token punctuation">,</span></span>
<span class="line">    parentNode<span class="token operator">:</span> hostParentNode<span class="token punctuation">,</span></span>
<span class="line">    nextSibling<span class="token operator">:</span> hostNextSibling<span class="token punctuation">,</span></span>
<span class="line">    setScopeId<span class="token operator">:</span> hostSetScopeId <span class="token operator">=</span> <span class="token constant">NOOP</span><span class="token punctuation">,</span></span>
<span class="line">    cloneNode<span class="token operator">:</span> hostCloneNode<span class="token punctuation">,</span></span>
<span class="line">    insertStaticContent<span class="token operator">:</span> hostInsertStaticContent<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token operator">=</span> options</span>
<span class="line"></span>
<span class="line">  <span class="token comment">// å®ç°å„ç§patchå‡½æ•°</span></span>
<span class="line">  <span class="token keyword">const</span> patch<span class="token operator">:</span> <span class="token function-variable function">PatchFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    n1<span class="token punctuation">,</span></span>
<span class="line">    n2<span class="token punctuation">,</span></span>
<span class="line">    container<span class="token punctuation">,</span></span>
<span class="line">    anchor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    parentComponent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    parentSuspense <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    namespace <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span></span>
<span class="line">    slotScopeIds <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    optimized <span class="token operator">=</span> __DEV__ <span class="token operator">&amp;&amp;</span> isHmrUpdating <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>n2<span class="token punctuation">.</span>dynamicChildren<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> shapeFlag <span class="token punctuation">}</span> <span class="token operator">=</span> n2</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">case</span> Text<span class="token operator">:</span></span>
<span class="line">        <span class="token function">processText</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">      <span class="token keyword">case</span> Comment<span class="token operator">:</span></span>
<span class="line">        <span class="token function">processCommentNode</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">      <span class="token keyword">case</span> Static<span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function">mountStaticNode</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">      <span class="token keyword">case</span> Fragment<span class="token operator">:</span></span>
<span class="line">        <span class="token function">processFragment</span><span class="token punctuation">(</span></span>
<span class="line">          n1<span class="token punctuation">,</span></span>
<span class="line">          n2<span class="token punctuation">,</span></span>
<span class="line">          container<span class="token punctuation">,</span></span>
<span class="line">          anchor<span class="token punctuation">,</span></span>
<span class="line">          parentComponent<span class="token punctuation">,</span></span>
<span class="line">          parentSuspense<span class="token punctuation">,</span></span>
<span class="line">          namespace<span class="token punctuation">,</span></span>
<span class="line">          slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">          optimized<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">      <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function">processElement</span><span class="token punctuation">(</span></span>
<span class="line">            n1<span class="token punctuation">,</span></span>
<span class="line">            n2<span class="token punctuation">,</span></span>
<span class="line">            container<span class="token punctuation">,</span></span>
<span class="line">            anchor<span class="token punctuation">,</span></span>
<span class="line">            parentComponent<span class="token punctuation">,</span></span>
<span class="line">            parentSuspense<span class="token punctuation">,</span></span>
<span class="line">            namespace<span class="token punctuation">,</span></span>
<span class="line">            slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">            optimized<span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function">processComponent</span><span class="token punctuation">(</span></span>
<span class="line">            n1<span class="token punctuation">,</span></span>
<span class="line">            n2<span class="token punctuation">,</span></span>
<span class="line">            container<span class="token punctuation">,</span></span>
<span class="line">            anchor<span class="token punctuation">,</span></span>
<span class="line">            parentComponent<span class="token punctuation">,</span></span>
<span class="line">            parentSuspense<span class="token punctuation">,</span></span>
<span class="line">            namespace<span class="token punctuation">,</span></span>
<span class="line">            slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">            optimized<span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TELEPORT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token class-name"><span class="token keyword">as</span></span> <span class="token keyword">typeof</span> TeleportImpl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span></span>
<span class="line">            n1<span class="token punctuation">,</span></span>
<span class="line">            n2<span class="token punctuation">,</span></span>
<span class="line">            container<span class="token punctuation">,</span></span>
<span class="line">            anchor<span class="token punctuation">,</span></span>
<span class="line">            parentComponent<span class="token punctuation">,</span></span>
<span class="line">            parentSuspense<span class="token punctuation">,</span></span>
<span class="line">            namespace<span class="token punctuation">,</span></span>
<span class="line">            slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">            optimized<span class="token punctuation">,</span></span>
<span class="line">            internals<span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__FEATURE_SUSPENSE__ <span class="token operator">&amp;&amp;</span> shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">SUSPENSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token class-name"><span class="token keyword">as</span></span> <span class="token keyword">typeof</span> SuspenseImpl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span></span>
<span class="line">            n1<span class="token punctuation">,</span></span>
<span class="line">            n2<span class="token punctuation">,</span></span>
<span class="line">            container<span class="token punctuation">,</span></span>
<span class="line">            anchor<span class="token punctuation">,</span></span>
<span class="line">            parentComponent<span class="token punctuation">,</span></span>
<span class="line">            parentSuspense<span class="token punctuation">,</span></span>
<span class="line">            namespace<span class="token punctuation">,</span></span>
<span class="line">            slotScopeIds<span class="token punctuation">,</span></span>
<span class="line">            optimized<span class="token punctuation">,</span></span>
<span class="line">            internals<span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    render<span class="token punctuation">,</span></span>
<span class="line">    createApp<span class="token operator">:</span> <span class="token function">createAppAPI</span><span class="token punctuation">(</span>render<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“Š-æ€§èƒ½ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-æ€§èƒ½ä¼˜åŒ–"><span>ğŸ“Š æ€§èƒ½ä¼˜åŒ–</span></a></h2><h3 id="_1-ç¼–è¯‘æ—¶ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_1-ç¼–è¯‘æ—¶ä¼˜åŒ–"><span>1. ç¼–è¯‘æ—¶ä¼˜åŒ–</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// é™æ€æå‡</span></span>
<span class="line"><span class="token keyword">const</span> hoisted <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&#39;static&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¡¥ä¸æ ‡å¿—</span></span>
<span class="line"><span class="token keyword">const</span> patchFlag <span class="token operator">=</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">CLASS</span> <span class="token operator">|</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">STYLE</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å—çº§ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">const</span> dynamicChildren <span class="token operator">=</span> <span class="token punctuation">[</span>dynamicVNode1<span class="token punctuation">,</span> dynamicVNode2<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-è¿è¡Œæ—¶ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_2-è¿è¡Œæ—¶ä¼˜åŒ–"><span>2. è¿è¡Œæ—¶ä¼˜åŒ–</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code><span class="line"><span class="token comment">// å¿«é€Ÿè·¯å¾„æ£€æŸ¥</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// æœ‰è¡¥ä¸æ ‡å¿—ï¼Œè¿›è¡Œä¼˜åŒ–æ›´æ–°</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">CLASS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åªæ›´æ–°ç±»å</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>patchFlag <span class="token operator">&amp;</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">STYLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åªæ›´æ–°æ ·å¼</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// æ— è¡¥ä¸æ ‡å¿—ï¼Œå…¨é‡æ›´æ–°</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å—çº§æ›´æ–°</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>dynamicChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// åªæ›´æ–°åŠ¨æ€å­èŠ‚ç‚¹</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dynamicChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">patch</span><span class="token punctuation">(</span>dynamicChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> newDynamicChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ¯-æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-æ€»ç»“"><span>ğŸ¯ æ€»ç»“</span></a></h2><p>Vue3çš„è™šæ‹ŸDOMç³»ç»Ÿå±•ç°äº†ç°ä»£å‰ç«¯æ¡†æ¶çš„è®¾è®¡ç²¾é«“ï¼š</p><ol><li><strong>é«˜æ•ˆDiffç®—æ³•</strong> - å¿«é€ŸDiff + æœ€é•¿é€’å¢å­åºåˆ—</li><li><strong>ç¼–è¯‘æ—¶ä¼˜åŒ–</strong> - é™æ€æå‡ + è¡¥ä¸æ ‡å¿— + å—çº§ä¼˜åŒ–</li><li><strong>è¿è¡Œæ—¶ä¼˜åŒ–</strong> - å¿«é€Ÿè·¯å¾„ + å—çº§æ›´æ–°</li><li><strong>è·¨å¹³å°æ”¯æŒ</strong> - æ¸²æŸ“å™¨æŠ½è±¡ + å¹³å°ç‰¹å®šå®ç°</li><li><strong>ç±»å‹å®‰å…¨</strong> - å®Œæ•´çš„TypeScriptæ”¯æŒ</li><li><strong>æ€§èƒ½ä¼˜å…ˆ</strong> - å¤šç§ä¼˜åŒ–ç­–ç•¥ç»„åˆ</li></ol><p>è¿™å¥—è™šæ‹ŸDOMç³»ç»Ÿä¸ä»…ä¸ºVue3æä¾›äº†é«˜æ•ˆçš„æ¸²æŸ“èƒ½åŠ›ï¼Œä¹Ÿä¸ºå…¶ä»–å‰ç«¯é¡¹ç›®æä¾›äº†ä¼˜ç§€çš„è®¾è®¡å‚è€ƒã€‚</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">æœ€è¿‘æ›´æ–°ï¼š: </span><time class="meta-item-info" datetime="2025-08-07T11:48:52.000Z" data-allow-mismatch>2025/8/7 11:48</time></div><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/blogs/02-reactivity-system.html" aria-label="Vue3å“åº”å¼ç³»ç»Ÿè¯¦è§£"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span class="external-link">Vue3å“åº”å¼ç³»ç»Ÿè¯¦è§£</span></div><!--]--></a><a class="route-link auto-link next" href="/blogs/04-compiler-system.html" aria-label="Vue3ç¼–è¯‘å™¨ç³»ç»Ÿè¯¦è§£"><!--[--><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span class="external-link">Vue3ç¼–è¯‘å™¨ç³»ç»Ÿè¯¦è§£</span></div><!--]--></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/blogs/assets/app-BYt8acor.js" defer></script>
  </body>
</html>
